<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>Painel Administrativo | SabApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- AdminLTE + Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    
body { padding-top: 56px; }

.btn-logout {
  color: #dc3545 !important;
  font-size: 1.1rem;
  transition: .2s;
}
.btn-logout:hover {
  color: #a71d2a !important;
  transform: scale(1.1);
}
.dark-mode .btn-logout { color: #ff6b6b !important; }

#mapAngola {
  height: 350px;
  border-radius: 10px;
}

/* =====================================================
   OVERLAYS
===================================================== */
.alunos-overlay,
.alunos-disponiveis-overlay,
.professores-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* =====================================================
   CONTAINERS
===================================================== */
.alunos-container,
.alunos-disponiveis-container,
.professores-container {
  background: #fff;
  border-radius: 14px;
  padding: 22px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 15px 40px rgba(0,0,0,.25);
}

.dark-mode
.alunos-container,
.dark-mode
.alunos-disponiveis-container,
.dark-mode
.professores-container {
  background: #1f2d3d;
}

/* =====================================================
   TABELA ‚Äî ALUNOS
===================================================== */
.alunos-container table.tabela-alunos {
  width: 100%;
  border-collapse: collapse;
}

.alunos-container table.tabela-alunos thead {
  background: linear-gradient(45deg,#007bff,#0056b3);
  color: #fff;
}

.alunos-container table.tabela-alunos th,
.alunos-container table.tabela-alunos td {
  padding: 11px;
  border-bottom: 1px solid #e1e1e1;
}

.dark-mode
.alunos-container table.tabela-alunos th,
.dark-mode
.alunos-container table.tabela-alunos td {
  border-color: #444;
}

/* ============================
   BOT√ÉO COPIAR TELEFONE
============================ */

.btn-copiar-tel {
  background: #0d6efd;
  color: #fff;
  border: none;
  padding: 4px 10px;
  margin-left: 6px;
  border-radius: 6px;
  font-size: 0.75rem;
  cursor: pointer;
  transition: .2s ease;
}

.btn-copiar-tel:hover {
  background: #0b5ed7;
  transform: scale(1.05);
}

/* ============================
   TOAST DE CONFIRMA√á√ÉO
============================ */

.toast-copia {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background: #222;
  color: white;
  padding: 12px 18px;
  border-radius: 10px;
  opacity: 0;
  transform: translateY(20px);
  transition: .3s ease;
  font-size: 0.9rem;
  z-index: 9999;
  box-shadow: 0 8px 25px rgba(0,0,0,.2);
}

.toast-copia.show {
  opacity: 1;
  transform: translateY(0);
}
    
/* =====================================================
   TABELA ‚Äî ALUNOS DISPON√çVEIS
===================================================== */
.alunos-disponiveis-container table.tabela-disponiveis {
  width: 100%;
  border-collapse: collapse;
}

.alunos-disponiveis-container table.tabela-disponiveis thead {
  background: linear-gradient(45deg,#17a2b8,#0f6674);
  color: #fff;
}

.alunos-disponiveis-container table.tabela-disponiveis th,
.alunos-disponiveis-container table.tabela-disponiveis td {
  padding: 11px;
  border-bottom: 1px solid #e1e1e1;
}

/* =====================================================
   TABELA ‚Äî PROFESSORES (LISTAGEM)
===================================================== */
.professores-container table.tabela-professores {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.professores-container table.tabela-professores thead {
  background: linear-gradient(45deg,#17a2b8,#117a8b);
  color: #fff;
}

.professores-container table.tabela-professores th,
.professores-container table.tabela-professores td {
  padding: 12px;
  border-bottom: 1px solid #e1e1e1;
}

/* =====================================================
   TABELA ‚Äî PAGAMENTOS ¬∑ PROFESSORES (NOVA)
===================================================== */
.professores-container table.tabela-pagamentos-professores {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.professores-container table.tabela-pagamentos-professores thead {
  background: linear-gradient(45deg,#28a745,#1e7e34);
  color: #fff;
}

.professores-container table.tabela-pagamentos-professores th,
.professores-container table.tabela-pagamentos-professores td {
  padding: 12px;
  border-bottom: 1px solid #e1e1e1;
}

/* valores monet√°rios */
.tabela-pagamentos-professores .valor {
  font-weight: 700;
  color: #28a745;
}

.dark-mode
.tabela-pagamentos-professores .valor {
  color: #6ee7b7;
}

/* status de pagamento */
.status-pago { color: #28a745; font-weight: 600; }
.status-pendente { color: #ffc107; font-weight: 600; }
.status-atrasado { color: #dc3545; font-weight: 600; }

/* =====================================================
   STATUS GERAIS
===================================================== */
.status-online { color: #28a745; font-weight: 600; }
.status-offline { color: #dc3545; font-weight: 600; }
.status-disponivel { color: #17a2b8; font-weight: 600; }

/* =====================================================
   BOT√ïES
===================================================== */
.btn-remover,
.btn-prof-remover {
  background: #dc3545;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
}
.btn-remover:hover,
.btn-prof-remover:hover { opacity: .85; }

   .btn-copiar {
  border: none;
  background: transparent;
  cursor: pointer;
  margin-left: 6px;
  font-size: 14px;
} 
    
/* =====================================================
   MOBILE ‚Äî ISOLADO POR TABELA
===================================================== */
@media (max-width: 768px) {

  .alunos-container table.tabela-alunos thead,
  .alunos-disponiveis-container table.tabela-disponiveis thead,
  .professores-container table.tabela-professores thead,
  .professores-container table.tabela-pagamentos-professores thead {
    display: none;
  }

  .alunos-container table.tabela-alunos tr,
  .alunos-disponiveis-container table.tabela-disponiveis tr,
  .professores-container table.tabela-professores tr,
  .professores-container table.tabela-pagamentos-professores tr {
    display: block;
    margin-bottom: 12px;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 10px;
    background: #fff;
  }

  .dark-mode
  .alunos-container table tr,
  .dark-mode
  .alunos-disponiveis-container table tr,
  .dark-mode
  .professores-container table tr {
    background: #1f2d3d;
    border-color: #444;
  }

  .alunos-container table td,
  .alunos-disponiveis-container table td,
  .professores-container table td {
    display: flex;
    justify-content: space-between;
    padding: 8px 6px;
    border: none;
  }

  .alunos-container table td::before,
  .alunos-disponiveis-container table td::before,
  .professores-container table td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #555;
  }

  .dark-mode table td::before {
    color: #bbb;
  }
}
 
</style>


</head>

<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- Navbar -->
<nav class="main-header navbar navbar-expand navbar-white navbar-light fixed-top">

  
  <ul class="navbar-nav">
    <li class="nav-item">
      <a class="nav-link" data-widget="pushmenu" href="#">
        <i class="fas fa-bars"></i>
      </a>
    </li>
  </ul>

  <!-- LADO DIREITO (OPPOSTO AO MENU) -->
  <ul class="navbar-nav ml-auto align-items-center">

    <!-- Dark Mode -->
    <li class="nav-item mr-2">
      <a class="nav-link" href="#" onclick="toggleDarkMode()" title="Modo escuro">
        <i class="fas fa-moon"></i>
      </a>
    </li>

    <!-- Logout -->
    <li class="nav-item">
      <a class="nav-link btn-logout" href="#" onclick="logoutConfirm()" title="Sair">
        <i class="fas fa-sign-out-alt"></i>
      </a>
    </li>

  </ul>
</nav>
  
  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">

    <a href="#" class="brand-link text-center">
      <span class="brand-text font-weight-light">Administra√ß√£o SabApp</span>
    </a>

    <!-- ===============================
         MENU
    ================================== -->
    <div class="sidebar">
      <nav class="mt-3">
        <ul class="nav nav-pills nav-sidebar flex-column"
            data-widget="treeview" role="menu" data-accordion="false">

      <!-- MENU ALUNOS -->
      <li class="nav-item has-treeview">
        <a href="#" class="nav-link">
          <i class="nav-icon fas fa-user-graduate"></i>
          <p>Alunos <i class="right fas fa-angle-left"></i></p>
        </a>
        <ul class="nav nav-treeview">
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="event.preventDefault(); carregarAlunos();">
              <i class="far fa-circle nav-icon"></i>
              <p>Alunos Cadastrados</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="event.preventDefault(); carregarAlunosDisponiveis();">
              <i class="far fa-circle nav-icon"></i>
              <p>Alunos sem v√≠nculo</p>
            </a>
          </li>
        </ul>
      </li>

      <!-- MENU PROFESSORES -->
      <li class="nav-item has-treeview">
        <a href="#" class="nav-link">
          <i class="nav-icon fas fa-chalkboard-teacher"></i>
          <p>Professores <i class="right fas fa-angle-left"></i></p>
        </a>
        <ul class="nav nav-treeview">
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="event.preventDefault(); carregarProfessores();">
              <i class="far fa-circle nav-icon"></i>
              <p>Professores Online</p>
            </a>
          </li>
        </ul>
      </li>

      <!-- MENU FINAN√áAS -->
      <li class="nav-item has-treeview">
        <a href="#" class="nav-link">
          <i class="nav-icon fas fa-coins"></i>
          <p>Finan√ßas <i class="right fas fa-angle-left"></i></p>
        </a>
        <ul class="nav nav-treeview">
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="event.preventDefault(); abrirFinanceAlunos();">
              <i class="far fa-circle nav-icon"></i>
              <p>Pagamentos Alunos</p>
            </a>
          </li>

          <li class="nav-item">
            <a href="#" class="nav-link"
               onclick="event.preventDefault(); abrirFinanceProf();">
              <i class="far fa-circle nav-icon"></i>
              <p>Paga. Professores</p>
            </a>
          </li>
        </ul>
      </li>

      <!-- ===============================
           NOVO MENU RH
      ================================= -->
      <li class="nav-item has-treeview">
        <a href="#" class="nav-link">
          <i class="nav-icon fas fa-users-cog"></i>
          <p>RH Administrativo <i class="right fas fa-angle-left"></i></p>
        </a>
        <ul class="nav nav-treeview">
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="abrirEquipaAdministrativa(); return false;">
              <i class="far fa-circle nav-icon"></i>
              <p>Equipa Administrativa</p>
            </a>
         </li>

          <li class="nav-item">
            <a href="#" class="nav-link" onclick="event.preventDefault(); abrirRemuneracoes();">
              <i class="far fa-circle nav-icon"></i>
              <p>Remunera√ß√µes e Sal√°rios</p>
            </a>
          </li>
        </ul>
      </li>

      <!-- ===============================
           MENU RELAT√ìRIOS
      ================================= -->
      <li class="nav-item has-treeview">
        <a href="#" class="nav-link">
          <i class="nav-icon fas fa-chart-line"></i>
          <p>Relat√≥rios <i class="right fas fa-angle-left"></i></p>
        </a>
        <ul class="nav nav-treeview">
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="event.preventDefault(); abrirRelatoriosMensais();">
              <i class="far fa-circle nav-icon"></i>
              <p>Relat√≥rios Mensais</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="event.preventDefault(); abrirRelatoriosDiarios();">
              <i class="far fa-circle nav-icon"></i>
              <p>Relat√≥rios Di√°rios</p>
            </a>
          </li>
        </ul>
      </li>

      <!-- ===============================
           MENU EXEMPLO 1
      ================================= -->
      <li class="nav-item has-treeview">
        <a href="#" class="nav-link">
          <i class="nav-icon fas fa-folder"></i>
          <p>Exemplo 1 <i class="right fas fa-angle-left"></i></p>
        </a>
        <ul class="nav nav-treeview">
          <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="far fa-circle nav-icon"></i>
              <p>Bot√£o 1</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="far fa-circle nav-icon"></i>
              <p>Bot√£o 2</p>
            </a>
          </li>
        </ul>
      </li>

      <!-- ===============================
           MENU EXEMPLO 2
      ================================= -->
      <li class="nav-item has-treeview">
        <a href="#" class="nav-link">
          <i class="nav-icon fas fa-folder-open"></i>
          <p>Exemplo 2 <i class="right fas fa-angle-left"></i></p>
        </a>
        <ul class="nav nav-treeview">
          <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="far fa-circle nav-icon"></i>
              <p>Bot√£o 1</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="far fa-circle nav-icon"></i>
              <p>Bot√£o 2</p>
            </a>
          </li>
        </ul>
      </li>

    </ul>
  </nav>
</div>

<!-- ===============================
     OVERLAY FINAN√áAS PROFESSORES
================================ -->
<div class="professores-overlay" id="overlayFinanceProf">
  <div class="professores-container tabela-wrapper">

    <div class="modal-header">
      <h3 class="modal-title">üí∞ Pagamentos ‚Äì Professores</h3>
      <button class="btn btn-secondary" onclick="fecharFinanceProf()">Fechar</button>
    </div>

    <table class="tabela-pagamentos" id="tabela-pagamentos-prof">
      <thead>
        <tr>
          <th>Professor</th>
          <th>Status</th>
          <th>Saldo Atual</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>

  </div>
</div>
<!-- ===============================
     DETALHES PAGAMENTOS PROFESSOR
================================ -->
<div class="professores-overlay" id="detalhes-prof">
  <div class="professores-container tabela-wrapper">

    <div class="modal-header">
      <div>
        <h3 class="modal-title" id="nome-prof">Professor</h3>
        <small>
          Saldo atual:
          <strong id="saldo-prof">0 Kz</strong>
        </small>
      </div>
      <button class="btn btn-secondary" onclick="fecharDetalhesProf()">Fechar</button>
    </div>

    <table class="tabela-pagamentos">
      <thead>
        <tr>
          <th>M√™s</th>
          <th>Data</th>
          <th>Valor</th>
          <th>Email</th>
          <th>Status</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tabela-meses">
        <!-- JS injeta linhas aqui -->
      </tbody>
    </table>

  </div>
</div>

  <div class="professores-overlay" id="overlayFinanceAlunos">
  <div class="professores-container">

    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4>üí∞ Pagamentos de Alunos</h4>
      <button class="btn btn-secondary" onclick="fecharFinanceAlunos()">Fechar</button>
    </div>

    <table class="tabela-professores" id="tabela-pagamentos">
      <thead>
        <tr>
          <th>Aluno</th>
          <th>Status</th>
          <th>D√≠vida</th>
          <th>√öltimo Pagamento</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>
</div>

<div class="professores-overlay" id="detalhes-aluno">
  <div class="professores-container">

    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4 id="nome-aluno">üìå Pagamentos</h4>
      <button class="btn btn-secondary" onclick="fecharDetalhesAluno()">Fechar</button>
    </div>

    <table class="tabela-professores">
      <thead>
        <tr>
          <th>M√™s</th>
          <th>Ano</th>
          <th>Valor</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tabela-meses"></tbody>
    </table>

  </div>
</div>          

<!-- ===============================
     TABELA ADMINISTRATIVA
================================ -->
<div class="professores-overlay" id="equipaAdministrativaWrapper" style="display:none;">
  <div class="professores-container tabela-wrapper">

    <!-- HEADER -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h2 class="modal-title">Equipa Administrativa</h2>
      <button class="btn btn-secondary" onclick="fecharEquipaAdministrativa()">‚úñ Fechar</button>
    </div>

    <!-- BOT√ÉO ADICIONAR PESSOAL -->
    <button class="btn btn-primary" onclick="document.getElementById('formAdd').style.display='block'">
      ‚ûï Adicionar Pessoal
    </button>

    <!-- TABELA -->
    <table class="tabela-professores">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Cargo</th>
          <th>Telefone</th>
          <th>Localiza√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for p in equipa %}
        <tr>
          <td data-label="Nome">{{ p.nome }}</td>
          <td data-label="Cargo">{{ p.cargo }}</td>
          <td data-label="Telefone">{{ p.telefone }}</td>
          <td data-label="Localiza√ß√£o">{{ p.localizacao }}</td>
          <td data-label="A√ß√µes">
            <button
              type="button"
              class="btn btn-warning"
              onclick="abrirEditar(
                '{{ p.id }}',
                '{{ p.nome }}',
                '{{ p.cargo }}',
                '{{ p.telefone }}',
                '{{ p.localizacao }}'
               )">
               ‚úèÔ∏è Editar
             </button>
           </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>
</div>

<!-- ===============================
     FORMUL√ÅRIO ADICIONAR PESSOAL
================================ -->
<div id="formAdd" class="professores-overlay" style="display:none;">
  <div class="professores-container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h3 class="professores-title">Adicionar Pessoal Administrativo</h3>
      <button class="btn btn-secondary" onclick="document.getElementById('formAdd').style.display='none'">‚úñ Fechar</button>
    </div>

    <form method="post" action="/equipa-administrativa/adicionar">
      <input name="nome" placeholder="Nome completo" required>
      <input name="cargo" placeholder="Cargo" required>
      <input name="telefone" placeholder="Telefone" required>
      <input name="localizacao" placeholder="Localiza√ß√£o" required>

      <button class="btn btn-primary">Guardar</button>
    </form>
  </div>
</div>
    
        </ul>
      </nav>
    </div>
  </aside>

  <!-- ===============================
       OVERLAYS (TODOS MANTIDOS)
  ================================== -->
  <!-- ALUNOS -->
  <div class="alunos-overlay" id="overlayAlunos">
    <div class="alunos-container">
      <div style="display:flex;justify-content:space-between">
        <div class="alunos-title">üìã Alunos Cadastrados</div>
        <button class="btn btn-secondary" onclick="fecharAlunos()">Fechar</button>
      </div>
      <table class="tabela-alunos" id="tabela-alunos">
        <thead>
          <tr>
            <th>Nome</th><th>Disciplina</th><th>Online</th><th>V√≠nculo</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ALUNOS SEM V√çNCULO -->
  <div class="alunos-disponiveis-overlay" id="overlayDisponiveis">
    <div class="alunos-disponiveis-container">
      <div style="display:flex;justify-content:space-between">
        <div class="alunos-title">üë§ Alunos sem v√≠nculo</div>
        <button class="btn btn-secondary" onclick="fecharAlunosDisponiveis()">Fechar</button>
      </div>
      <table class="tabela-disponiveis" id="tabela-disponiveis">
        <thead>
          <tr>
            <th>Nome</th><th>Disciplina</th><th>Bairro</th><th>Prov√≠ncia</th><th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

 <!-- PROFESSORES -->
<div class="professores-overlay" id="overlayProfessores">
  <div class="professores-container">
    <div style="display:flex;justify-content:space-between">
      <div class="alunos-title">üë®‚Äçüè´ Professores Online</div>
      <button class="btn btn-secondary" onclick="fecharProfessores()">Fechar</button>
    </div>

    <table class="tabela-professores" id="tabela-professores">
      <thead>
        <tr>
          <th>Email</th>
          <th>Nome</th>
          <th>Telefone</th> 
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>

      <tbody></tbody>
    </table>
  </div>
</div>


 <!-- Conte√∫do -->
  <div class="content-wrapper">
    <section class="content pt-3">
      <div class="container-fluid">

        <!-- CARDS -->
        <div class="row">

          <div class="col-lg-3 col-6">
            <div class="small-box bg-info">
              <div class="inner">
                <h3 id="total-alunos">0</h3>
                <p>Alunos</p>
              </div>
              <div class="icon"><i class="fas fa-user-graduate"></i></div>
            </div>
          </div>

          <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
              <div class="inner">
                <h3 id="total-professores">0</h3>
                <p>Professores</p>
              </div>
              <div class="icon"><i class="fas fa-chalkboard-teacher"></i></div>
            </div>
          </div>

          <div class="col-lg-3 col-6">
            <div class="small-box bg-warning">
              <div class="inner">
                <h3 id="chamadas-ativas">0</h3>
                <p>Aulas Ativas</p>
              </div>
              <div class="icon"><i class="fas fa-video"></i></div>
            </div>
          </div>

          <div class="col-lg-3 col-6">
            <div class="small-box bg-danger">
              <div class="inner">
                <h3 id="alunos-nao-vinculados">0</h3>
                <p>Alunos N√£o Vinculados</p>
              </div>
              <div class="icon"><i class="fas fa-unlink"></i></div>
            </div>
          </div>

        </div>

        <!-- GR√ÅFICO + MAPA -->
        <div class="row">

          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Resumo Geral</h3>
              </div>
              <div class="card-body">
                <canvas id="grafico"></canvas>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Mapa de Angola</h3>
              </div>
              <div class="card-body">
                <div id="mapAngola"></div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </section>
  </div>

  <footer class="main-footer text-center">
    <strong>Todos os Direitos reservados √† SabApp 2026</strong>
  </footer>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
}


fetch("/estatisticas-dashboard")
  .then(res => res.json())
  .then(dados => {

    document.getElementById("total-alunos").innerText = dados.alunos.total;
    document.getElementById("total-professores").innerText = dados.professores.total;
    document.getElementById("chamadas-ativas").innerText = dados.chamadas.em_andamento;
    document.getElementById("alunos-nao-vinculados").innerText = dados.alunos.nao_vinculados;

    new Chart(document.getElementById("grafico"), {
      type: "doughnut",
      data: {
        labels: [
          "Alunos Online",
          "Alunos Offline",
          "Vinculados",
          "N√£o Vinculados"
        ],
        datasets: [{
          data: [
            dados.alunos.online,
            dados.alunos.offline,
            dados.alunos.vinculados,
            dados.alunos.nao_vinculados
          ]
        }]
      }
    });
  });

// üó∫Ô∏è MAPA
const map = L.map('mapAngola').setView([-11.2027, 17.8739], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([-8.839, 13.289]).addTo(map).bindPopup("Luanda");

async function carregarAlunos() {

  const overlay = document.getElementById("overlayAlunos");
  const tbody = document.querySelector("#tabela-alunos tbody");

  if (!overlay || !tbody) {
    console.error("Overlay ou tabela n√£o encontrados");
    return;
  }

  overlay.style.display = "flex";

  tbody.innerHTML = `
    <tr>
      <td colspan="6" class="loader-alunos">
        Carregando alunos...
      </td>
    </tr>
  `;

  try {

    const res = await fetch("/listar-alunos");

    if (!res.ok) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="loader-alunos" style="color:red">
            Erro ao buscar alunos
          </td>
        </tr>
      `;
      return;
    }

    let alunos = await res.json();

    alunos = alunos.filter(a =>
      a &&
      a.nome &&
      a.nome.toString().trim() !== ""
    );

    tbody.innerHTML = "";

    if (!alunos.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" style="text-align:center;font-weight:bold">
            Nenhum aluno v√°lido encontrado
          </td>
        </tr>
      `;
      return;
    }

    alunos.forEach(a => {

      const nome = a.nome?.toString().trim() || "‚Äî";
      const disciplina = a.disciplina || "‚Äî";
      const telefone = a.telefone || "‚Äî";

      tbody.innerHTML += `
        <tr>
          <td data-label="Nome">${nome}</td>
          <td data-label="Disciplina">${disciplina}</td>

          <td data-label="Telefone">
            ${telefone}
            <button class="btn-copiar"
                onclick="copiarTelefone('${telefone}')">
                üìã
            </button>
          </td>

          <td data-label="Status"
              class="${a.online ? 'status-online' : 'status-offline'}">
            ${a.online ? "Online" : "Offline"}
          </td>

          <td data-label="Vinculado">
            <span class="${a.vinculado ? 'status-vinculado' : 'status-nao-vinculado'}">
              ${a.vinculado ? "Sim" : "N√£o"}
            </span>
          </td>

          <td data-label="A√ß√µes">
            <button class="btn-remover"
              onclick="removerAluno('${nome}')">
              Remover
            </button>
          </td>
        </tr>
      `;
    });

  } catch (err) {

    console.error("Erro JS:", err);

    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="loader-alunos" style="color:red">
          Erro inesperado
        </td>
      </tr>
    `;
  }

}

function copiarTelefone(numero) {

  if (!numero || numero === "‚Äî") return;

  navigator.clipboard.writeText(numero).then(() => {
    alert("üìû N√∫mero copiado: " + numero);
  });

}

async function removerAluno(nome) {

  if (!nome) return;

  const confirmar = confirm(
    `Tem certeza que deseja remover o aluno:\n${nome}?`
  );

  if (!confirmar) return;

  try {

    const res = await fetch("/remover-aluno", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ nome })
    });

    const data = await res.json();

    console.log("üîç Resposta backend:", data);

    alert(data.message || "Aluno removido com sucesso ‚úÖ");
    carregarAlunos(); // üîÑ Atualiza a tabela

  } catch (err) {
    console.error(err);
    alert("Erro de conex√£o com o servidor ‚ùå");
  }
}
  
function fecharAlunos() {
  const overlay = document.getElementById("overlayAlunos");

  if (overlay) {
    overlay.style.display = "none";
  }
}
  
  async function carregarAlunosDisponiveis() {

  const overlay = document.getElementById("overlayDisponiveis");
  const tbody = document.querySelector("#tabela-disponiveis tbody");

  if (!overlay || !tbody) {
    console.error("Overlay ou tabela dispon√≠veis n√£o encontrados");
    return;
  }

  overlay.style.display = "flex";

  tbody.innerHTML = `
    <tr>
      <td colspan="5" class="loader-disponiveis">
        Carregando alunos...
      </td>
    </tr>
  `;

  try {

    const res = await fetch("/alunos-nao-vinculados");

    if (!res.ok) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="loader-disponiveis" style="color:red">
            Erro ao buscar alunos
          </td>
        </tr>
      `;
      return;
    }

    let alunos = await res.json();

    // filtra nomes vazios
    alunos = alunos.filter(a =>
      a.nome && a.nome.toString().trim() !== ""
    );

    tbody.innerHTML = "";

    if (!alunos.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;font-weight:bold">
            Nenhum aluno dispon√≠vel
          </td>
        </tr>
      `;
      return;
    }

    alunos.forEach(a => {

      tbody.innerHTML += `
        <tr>
          <td>${a.nome}</td>
          <td>${a.disciplina || "‚Äî"}</td>
          <td>${a.bairro || "‚Äî"}</td>
          <td>${a.provincia || "‚Äî"}</td>
          <td class="status-disponivel">
            ${a.online ? "Online" : "Offline"}
          </td>
        </tr>
      `;
    });

  } catch (err) {

    console.error("Erro JS:", err);

    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="loader-disponiveis" style="color:red">
          Erro inesperado
        </td>
      </tr>
    `;
  }
}
  
function fecharAlunosDisponiveis() {

  const overlay = document.getElementById("overlayDisponiveis");
  const tbody = document.querySelector("#tabela-disponiveis tbody");

  // fecha o overlay
  if (overlay) {
    overlay.style.display = "none";
  }

  // limpa tabela
  if (tbody) {
    tbody.innerHTML = "";
  }
}

async function carregarProfessores() {

  const overlay = document.getElementById("overlayProfessores");
  const tbody = document.querySelector("#tabela-professores tbody");
  const select = document.getElementById("lista-professores");

  if (!overlay || !tbody) {
    console.error("Overlay professores n√£o encontrado");
    return;
  }

  overlay.style.display = "flex";

  tbody.innerHTML = `
    <tr>
      <td colspan="5" class="loader-alunos">
        Carregando professores...
      </td>
    </tr>
  `;

  try {

    const res = await fetch("/listar-professores-online");

    if (!res.ok) throw new Error();

    const profs = await res.json();

    tbody.innerHTML = "";

    if (!profs.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;font-weight:bold">
            Nenhum professor online
          </td>
        </tr>
      `;
      return;
    }

    if (select) {
      select.innerHTML = `
        <option disabled selected>Selecione o professor</option>
        <option value="todos">Todos os Professores</option>
      `;
    }

    profs.forEach(p => {

      tbody.innerHTML += `
        <tr>

          <td data-label="Email">${p.email || "-"}</td>

          <td data-label="Nome">${p.nome || "-"}</td>

          <td data-label="Telefone">
            <span class="telefone-texto">${p.telefone || "-"}</span>

            ${p.telefone ? `
              <button 
                class="btn-copiar-tel"
                onclick="copiarTelefone('${p.telefone}')">
                Copiar
              </button>
            ` : ""}
          </td>

          <td data-label="Status"
              class="${p.online ? 'prof-online' : 'prof-offline'}">
            ${p.online ? "Online" : "Offline"}
          </td>

          <td data-label="A√ß√µes">
            <button class="btn-prof-remover"
              onclick="removerProfessor('${p.email}')">
              Remover
            </button>
          </td>

        </tr>
      `;

      if (select && p.email) {
        select.innerHTML += `
          <option value="${p.email}">
            ${p.nome} - ${p.telefone || "Sem n¬∫"}
          </option>`;
      }

    });

  } catch (err) {

    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="loader-alunos" style="color:red">
          Erro ao carregar professores
        </td>
      </tr>
    `;

  }

}

  function copiarTelefone(numero) {

  if (!numero || numero === "-") {
    alert("N√∫mero indispon√≠vel");
    return;
  }

  navigator.clipboard.writeText(numero)
    .then(() => {

      const toast = document.createElement("div");
      toast.className = "toast-copia";
      toast.innerText = "üìã N√∫mero copiado!";

      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add("show"), 50);

      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, 2000);

    })
    .catch(() => alert("Erro ao copiar n√∫mero"));
}

async function removerProfessor(email) {

  if (!email) return;

  const confirmar = confirm(
    `Tem certeza que deseja remover o professor:\n${email}?`
  );

  if (!confirmar) return;

  try {

    const res = await fetch("/remover-professor", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ email })
    });

    const data = await res.json();

    console.log("üîç Resposta backend:", data);

    // üî• SEMPRE trata como sucesso
    alert(data.message || "Professor removido com sucesso ‚úÖ");
    carregarProfessores(); // üîÑ Atualiza a tabela

  } catch (err) {
    console.error(err);
    alert("Erro de conex√£o com o servidor ‚ùå");
  }
}

  
function fecharProfessores() {

  const overlay = document.getElementById("overlayProfessores");
  const tbody = document.querySelector("#tabela-professores tbody");

  if (overlay) overlay.style.display = "none";

  if (tbody) tbody.innerHTML = "";
}

 async function marcarPago(alunoId, temDivida) {

  if (!temDivida) {
    alert("Este aluno j√° est√° com o pagamento em dia.");
    return;
  }

  const res = await fetch("/listar-pagamentos");
  const alunos = await res.json();

  const aluno = alunos.find(a => a.id === alunoId && a.nome);

  if (!aluno) {
    alert("Aluno n√£o encontrado.");
    return;
  }

  const hoje = new Date();
  const mes = hoje.getMonth() + 1;
  const ano = hoje.getFullYear();

  const resposta = await fetch("/api/registrar-pagamento", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      aluno_nome: aluno.nome,
      mes,
      ano,
      valor_pago: aluno.valor_mensal_aluno || 0,
      pago: true
    })
  });

  if (resposta.ok) {
    alert("Pagamento registrado com sucesso!");
    carregarPagamentos();
  } else {
    alert("Erro ao registrar pagamento.");
  }
}

async function carregarPagamentos() {

  const res = await fetch("/listar-pagamentos");
  const alunos = await res.json();
  const tbody = document.querySelector("#tabela-pagamentos tbody");

  tbody.innerHTML = "";

  alunos.forEach(a => {

    if (!a.nome) return;

    const temDivida = a.divida && Number(a.divida) > 0;
    const statusTexto = temDivida ? "N√£o Pago" : "Pago";
    const statusCor = temDivida ? "prof-offline" : "prof-online";

    let ultimoPagamento = "‚Äî";
    if (a.paga_passado?.length) {
      const u = a.paga_passado[a.paga_passado.length - 1];
      ultimoPagamento = `${u.mes}/${u.ano} - Kz ${Number(u.valor_pago).toLocaleString("pt-AO")},00`;
    }

    tbody.innerHTML += `
      <tr>
        <td>${a.nome}</td>
        <td class="${statusCor}">${statusTexto}</td>
        <td>Kz ${Number(a.divida || 0).toLocaleString("pt-AO")},00</td>
        <td>${ultimoPagamento}</td>
        <td>
          <button class="btn-prof-remover"
            onclick="marcarPago('${a.id}', ${temDivida})">
            PAGO
          </button>

          <button class="btn btn-info btn-sm"
            onclick="verPagamentos('${a.nome}', '${a.nome}')">
            Ver
          </button>
        </td>
      </tr>
    `;
  });
}

  async function verPagamentos(nomeAluno, nomeExibicao) {

  const res = await fetch(`/ver-pagamentos/${encodeURIComponent(nomeAluno)}`);
  const data = await res.json();

  document.getElementById("nome-aluno").innerText =
    `üìå Pagamentos de ${nomeExibicao}`;

  const tbody = document.getElementById("tabela-meses");
  tbody.innerHTML = "";

  if (!data.historico_pagamentos.length) {
    tbody.innerHTML = `<tr><td colspan="4">Nenhum pagamento encontrado</td></tr>`;
  }

  data.historico_pagamentos.forEach(p => {
    tbody.innerHTML += `
      <tr>
        <td>${p.mes}</td>
        <td>${p.ano}</td>
        <td>Kz ${Number(p.valor_pago).toLocaleString("pt-AO")},00</td>
        <td style="color:green;font-weight:bold">Pago</td>
      </tr>
    `;
  });

  document.getElementById("detalhes-aluno").style.display = "flex";
}
  
  

  function abrirFinanceAlunos() {
  document.getElementById("overlayFinanceAlunos").style.display = "flex";
  carregarPagamentos();
}

function fecharFinanceAlunos() {
  document.getElementById("overlayFinanceAlunos").style.display = "none";
}

function fecharDetalhesAluno() {
  document.getElementById("detalhes-aluno").style.display = "none";
}

/* ==============================
   ABRIR FINAN√áAS PROFESSORES
================================ */
function abrirFinanceProf() {
  const overlay = document.getElementById("overlayFinanceProf");
  overlay.style.display = "flex";

  carregarPagamentosProf();
}

/* ==============================
   LISTAR PAGAMENTOS PROFESSORES
================================ */
async function carregarPagamentosProf() {
  try {
    const res = await fetch("/listar-pagamentos-prof");
    const professores = await res.json();
    const tbody = document.querySelector("#tabela-pagamentos-prof tbody");

    tbody.innerHTML = "";

    professores.forEach(p => {

      const statusPago = Number(p.saldo_atual) <= 0;
      const statusCor = statusPago ? "status-verde" : "status-vermelho";
      const statusTexto = statusPago ? "PAGO" : "N√ÉO PAGO";

      tbody.innerHTML += `
        <tr>
          <td>${p.professor}</td>
          <td>
            <span class="status-circulo ${statusCor}"></span>
            ${statusTexto}
          </td>
          <td>${Number(p.saldo_atual).toFixed(2)} Kz</td>
          <td>
            <button
              onclick="marcarPagoProf('${p.id}', ${statusPago}, '${p.professor}', ${p.saldo_atual})"
              style="background:${statusPago ? 'green' : 'red'};color:white;border:none;padding:4px 8px;border-radius:4px;">
              ${statusTexto}
            </button>

            <button
              onclick="verMesesProf('${p.id}')"
              style="background:#007bff;color:white;border:none;padding:4px 8px;border-radius:4px;margin-left:5px;">
              Ver Meses
            </button>
          </td>
        </tr>
      `;
    });

  } catch (err) {
    console.error("Erro ao carregar pagamentos de professores:", err);
    alert("Erro ao carregar pagamentos.");
  }
}

/* ==============================
   MARCAR PAGO / N√ÉO PAGO
================================ */
async function marcarPagoProf(id, statusPago, professor, saldoAtual) {
  try {

    if (!statusPago) {
      await fetch("/registrar-pagamento-prof", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id,
          professor,
          valor_pago: saldoAtual
        })
      });
    } else {
      await fetch("/atualizar-pagamento-prof", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id,
          professor,
          valor_pago: 0
        })
      });
    }

    carregarPagamentosProf();

  } catch (err) {
    console.error("Erro ao atualizar pagamento do professor:", err);
    alert("Erro ao atualizar pagamento.");
  }
}

/* ==============================
   VER MESES DO PROFESSOR
================================ */
async function verMesesProf(id) {
  try {
    const res = await fetch(`/salarios?email=${encodeURIComponent(id)}`);
    const data = await res.json();

    if (!data || !data.nome) {
      alert("Professor n√£o encontrado.");
      return;
    }

    document.getElementById("nome-prof").textContent = data.nome;
    document.getElementById("saldo-prof").textContent =
      `${Number(data.saldo_atual).toFixed(2)} Kz`;

    const tbody = document.getElementById("tabela-meses");
    tbody.innerHTML = "";

    if (!data.pagamentos || !data.pagamentos.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" style="color:#777;">Nenhum pagamento registrado</td>
        </tr>
      `;
    }

    data.pagamentos.forEach(p => {
      const pago = Number(p.valor_pago) > 0;
      const cor = pago ? "status-verde" : "status-vermelho";
      const texto = pago ? "PAGO" : "N√ÉO PAGO";

      tbody.innerHTML += `
        <tr>
          <td>${p.mes}</td>
          <td>${p.data_pagamento || "-"}</td>
          <td>${Number(p.valor_pago).toFixed(2)} Kz</td>
          <td>${p.email_professor || "-"}</td>
          <td><span class="${cor}">${texto}</span></td>
          <td>
            <button
              onclick="marcarPagoMesProf('${id}', '${p.mes}', ${pago})"
              style="background:${pago ? 'green' : 'red'};color:white;border:none;padding:4px 8px;border-radius:4px;">
              ${texto}
            </button>
          </td>
        </tr>
      `;
    });

    document.getElementById("detalhes-prof").style.display = "flex";

  } catch (err) {
    console.error("Erro ao carregar meses do professor:", err);
    alert("Erro ao carregar detalhes.");
  }
}

document.addEventListener("DOMContentLoaded", function () {

  document.querySelectorAll(".nav-item.has-treeview > a").forEach(link => {

    link.addEventListener("click", function (e) {

      e.preventDefault();
      e.stopPropagation();         
      e.stopImmediatePropagation(); 

      const parent = this.closest(".nav-item");
      const submenu = parent.querySelector(".nav-treeview");

      if (!submenu) return;

      // Toggle manual controlado
      if (parent.classList.contains("menu-open")) {
        parent.classList.remove("menu-open");
        submenu.style.display = "none";
      } else {
        parent.classList.add("menu-open");
        submenu.style.display = "block";
      }

    }, true); 
    
  });

});
  
  document.addEventListener("DOMContentLoaded", function () {

  window.abrirEquipaAdministrativa = function () {
    const overlay = document.getElementById("equipaAdministrativaWrapper");
    if (!overlay) {
      console.warn("equipaAdministrativaWrapper n√£o encontrado");
      return;
    }

    // Fecha outros overlays abertos (opcional, mas recomendado)
    document.querySelectorAll(".professores-overlay").forEach(el => {
      el.style.display = "none";
    });

    overlay.style.display = "flex";
  };

  window.fecharEquipaAdministrativa = function () {
    const overlay = document.getElementById("equipaAdministrativaWrapper");
    if (!overlay) {
      console.warn("equipaAdministrativaWrapper n√£o encontrado");
      return;
    }

    overlay.style.display = "none";
  };

});

function abrirEditar(id, nome, cargo, telefone, localizacao) {
  console.log("Abrir edi√ß√£o:", id);

  const overlay = document.getElementById("formEdit");
  const form = document.getElementById("formEditar");

  if (!overlay || !form) {
    console.warn("Modal ou formul√°rio de edi√ß√£o n√£o encontrado");
    return;
  }

  // Define a rota correta
  form.action = "/equipa-administrativa/editar/" + id;

  // Preenche os campos
  document.getElementById("editNome").value = nome;
  document.getElementById("editCargo").value = cargo;
  document.getElementById("editTelefone").value = telefone;
  document.getElementById("editLocalizacao").value = localizacao;

  // Mostra o modal
  overlay.style.display = "flex";
}
  
/* ==============================
   FECHAR OVERLAYS
================================ */
function fecharFinanceProf() {
  document.getElementById("overlayFinanceProf").style.display = "none";
}

function fecharDetalhesProf() {
  document.getElementById("detalhes-prof").style.display = "none";
}

  function logoutConfirm() {
    if (confirm("Tem certeza que deseja sair do painel administrativo?")) {
      window.location.href = "/logout";
    }
  }

  function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem(
      "darkMode",
      document.body.classList.contains("dark-mode")
    );
  }

  // Persist√™ncia do dark mode
  window.onload = () => {
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark-mode");
    }
  };

</script>

</body>
</html>






