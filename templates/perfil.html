<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfil do Aluno - Estilo BAI</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: #f5f7fa; /* fundo mais suave */
    color: #2c3e50;
    max-width: 480px;
    margin: auto;
  }

  .top-bar {
    background: linear-gradient(135deg, #00c9ff, #92fe9d); /* Mantida */
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    border-radius: 0 0 20px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .top-bar img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
  }

  .top-bar .info {
    display: flex;
    flex-direction: column;
  }

  .top-bar .info h2 {
    font-size: 1rem;
    margin: 0;
    color: #ffffff;
  }

  .top-bar .info p {
    margin: 2px 0;
    color: rgba(255, 255, 255, 0.9);
  }

  .saldo {
    font-size: 1.1rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #34495e;
    flex-direction: column;
    align-items: flex-start;
    margin-top: 8px;
  }

  .saldo button {
    background: none;
    border: none;
    color: #2c3e50;
    cursor: pointer;
  }

  .carrossel-indicadores {
    margin-top: 8px;
    text-align: center;
  }

  .carrossel-indicadores span {
    display: inline-block;
    width: 10px;
    height: 10px;
    margin: 0 3px;
    border-radius: 50%;
    background-color: #1abc9c;
  }

  .acoes {
    display: flex;
    justify-content: space-around;
    background: #ecf0f1;
    padding: 15px 0;
    flex-wrap: wrap;
  }

  .acao {
    width: 70px;
    height: 70px;
    background: #d0f0ef;
    border-radius: 15px;
    text-align: center;
    padding-top: 8px;
    margin: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  .acao i {
    font-size: 20px;
    display: block;
    color: #16a085;
  }

 .acao span {
   font-size: 12px;
   color: #000000; /* preto */
 }
  
  .ultimas-aulas {
    background: #ffffff;
    border-radius: 15px;
    margin: 15px;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .aula-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dfe6e9;
    padding: 8px 0;
  }

  .aula-info {
    flex: 1;
    color: #2c3e50;
  }

  .aula-valor {
    font-weight: bold;
    color: #2c3e50;
  }

  p {
  color: inherit;
  text-decoration: none;
}

p a {
  color: inherit;
  text-decoration: none;
  pointer-events: none;
}
  
  .footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    max-width: 480px;
    background: #ffffff;
    border-top: 1px solid #dcdde1;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 10px 0;
  }

  .footer .item {
    text-align: center;
    color: #7f8c8d;
    font-size: 12px;
  }

  .footer .item.active {
    color: #1abc9c;
  }

  .footer .item i {
    font-size: 20px;
    display: block;
  }
</style>

</head>
<body>
  <div class="top-bar">
    <img src="/static/perfil.png" alt="Perfil" />
    <div class="info">
      <h2>Ol√°, {{ aluno.nome }} üëã</h2>
      <p>B.I: {{ aluno.bilhete }}</p>

      <div class="saldo">
        <p style="margin: 0; font-size: 11px; font-family: 'Arial', sans-serif;">
          <strong style="font-size: 11px;">Por pagar:</strong>
          <span id="valor-divida" data-real="{{ total_gasto }}">Kz {{ total_gasto }},00</span>
          <button onclick="toggleVisibilidade()" style="margin-left: 10px;">üëÅÔ∏è</button><br>
        </p>

        <strong style="font-size: 11px;">N√≠vel de Ingl√™s:</strong>
        <span id="nivel-ingles">{{ aluno.nivel_ingles }}</span>
      </div>

      <div class="carrossel-indicadores">
        <span></span>
        <span style="opacity: 0.3;"></span>
      </div>
    </div>
  </div>

  <div class="acoes">
    <div class="acao" onclick="toggleAulas()">
      <i>üìò</i>
      <span>Ver Aulas</span>
    </div>
    <div class="acao" onclick="verNotificacao()">
      <i>üîîüë®‚Äçüè´</i>
      <span>Sala de aula</span>
    </div>
    <div class="acao" onclick="verHorario()">
      <i>üìÖ</i>
      <span>Ver Hor√°rio</span>
    </div>
    <div class="acao" onclick="toggle('sec-notas')">
      <i>üìù</i>
      <span>Ver Notas</span>
    </div>
    <div class="acao" onclick="toggleProfessor()">
      <i>üë®‚Äçüè´</i>
      <span>Ver Professor</span>
    </div>
  </div>
<!-- Link para √≠cones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Bot√£o para abrir o desafio (centralizado) -->
<div style="display: flex; justify-content: center; margin: 10px 0; background: url('/static/fundo.jpg') no-repeat center center; background-size: cover; padding: 15px 0;">
  <button 
      id="btn-desafio"
      onclick="toggleDesafio()"
      style="padding: 8px 14px; background: #1abc9c; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 14px;">
      <i class="fa-solid fa-puzzle-piece"></i> Desafio
  </button>
</div>

<!-- Desafio de Ingl√™s (inicialmente escondido) -->
<div id="container-desafio" style="display: none;">
  <div class="jogo-ingles" id="jogo-ingles" 
      style="margin: 5px 15px 15px 15px; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); max-height: 260px; overflow-y: auto; position: relative;">

    <!-- Bot√£o de fechar -->
    <button 
      onclick="fecharDesafio()"
      style="position: absolute; top: 8px; right: 8px; background: none; border: none; font-size: 18px; cursor: pointer; color: #888;">
      <i class="fa-solid fa-xmark"></i>
    </button>

    <h3 style="margin-top: 0;">üß† Desafio de Ingl√™s</h3>
    <p><strong>N√≠vel:</strong> <span id="nivel-aluno">{{ aluno.nivel_ingles }}</span></p>
    <p id="pergunta-texto" style="margin: 8px 0;">Loading...</p>

    <div style="display: flex; gap: 8px; align-items: center;">
      <input
        type="text"
        id="resposta-input"
        placeholder="Escreve a resposta..."
        style="flex: 1; padding: 6px; font-size: 13px; border-radius: 6px; border: 1px solid #ccc;"
      />
      <button
        id="btn-verificar"
        onclick="verificarResposta()"
        style="padding: 8px 14px; background: #1abc9c; color: white; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap; font-size: 14px;">
        Verificar
      </button>
    </div>
  </div>
</div>


<script>
function toggleDesafio() {
    const desafio = document.getElementById('container-desafio');
    desafio.style.display = (desafio.style.display === 'none' || desafio.style.display === '') 
        ? 'block' 
        : 'none';
}

function fecharDesafio() {
    document.getElementById('container-desafio').style.display = 'none';
}
</script>


  <p id="mensagem-feedback" style="margin-top: 10px; font-weight: bold;"></p>
</div>

  <div class="footer">
  <div class="item active" onclick="abrirPerfil()">
    <i>üë§</i>
    O Meu Perfil
  </div>
  <div class="item" onclick="abrirPagamentos()">
    <i>üí≥</i>
    Pagamentos
  </div>
  <div class="item" onclick="abrirMenu()">
    <i>üìÇ</i>
    Menu
  </div>
</div>

<script>
function abrirPerfil() {
  // Aqui voc√™ coloca a navega√ß√£o para o perfil
  window.location.href = '/perfil'; 
}

function abrirMenu() {
  // Aqui a navega√ß√£o para o menu
  window.location.href = '/menu';
}

function abrirPagamentos() {
  // Redireciona para a p√°gina de controle de pagamentos
  window.location.href = '/pagamentos'; 
}
</script>


  <!-- Se√ß√£o para exibir detalhes das aulas -->
  <div id="sec-aula" style="display:none;">
    <p id="aulas-dadas"></p>
    <p id="aulas-restantes"></p>
    <ul id="lista-aulas"></ul>
  </div>

  <!-- Se√ß√£o do professor -->
  <div id="professor-nome" style="display:none;"></div>

  <!-- Se√ß√£o de notifica√ß√µes -->
  <div id="notificacao-mensagem" style="display:none;"></div>
  <span id="contador-aulas"></span>

  <!-- Se√ß√£o de hor√°rio -->
  <div id="sec-horario" style="display:none;">
    <ul id="lista-horario"></ul>
  </div>

  <!-- Se√ß√£o para chamadas ao vivo -->
  <div id="info-aula" style="display:none;">
    <span id="sala-id"></span>
    <button onclick="entrarNaAulaDireto()">Entrar na Aula</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, doc, onSnapshot, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  console.log("M√≥dulo carregado ‚Äî inicializando app e exportando fun√ß√µes para window...");

  const firebaseConfig = {
    apiKey: "AIzaSyChMkODt7BhNLD-fK5NrY6-LmjJL6DtBIE",
    authDomain: "exap-8a935.firebaseapp.com",
    projectId: "exap-8a935",
    storageBucket: "exap-8a935.appspot.com",
    messagingSenderId: "664710895978",
    appId: "1:664710895978:web:304790f37d7561d9b1ed13"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Dados do template
  const nomeAluno = "{{ aluno.nome }}";

  // ---------------------------
  // FUN√á√ïES / L√ìGICA EXPOSAS
  // ---------------------------

  // ---- Chamadas ao vivo (Firestore) ----
  const chamadaRef = doc(db, "chamadas_ao_vivo", nomeAluno);
  const infoAulaDiv = document.getElementById("info-aula");
  const salaIdSpan = document.getElementById("sala-id");

  onSnapshot(chamadaRef, (docSnap) => {
    try {
      if (docSnap.exists()) {
        const dados = docSnap.data();
        if (dados.status === "pendente") {
          salaIdSpan.textContent = dados.sala;
          infoAulaDiv.style.display = "block";
          const aceitar = confirm(`üì° O professor ${dados.professor} est√° te chamando para uma aula. Deseja entrar?`);
          updateDoc(chamadaRef, {
            status: aceitar ? "aceito" : "rejeitado"
          });
          if (aceitar) {
            window.location.href = `/sala_virtual_aluno/${dados.sala}`;
          }
        }
      }
    } catch (e) {
      console.error("Erro no onSnapshot:", e);
    }
  });

  // ---- A√ß√µes principais (torna-as globais) ----
  window.toggleAulas = async function () {
    const div = document.getElementById("sec-aula");
    const aulasDadas = document.getElementById("aulas-dadas");
    const aulasRestantes = document.getElementById("aulas-restantes");
    const listaAulas = document.getElementById("lista-aulas");

    if (div.style.display === "block") {
      div.style.display = "none";
      return;
    }

    aulasDadas.textContent = "...carregando...";
    aulasRestantes.textContent = "";
    listaAulas.innerHTML = "";

    try {
      const response = await fetch("/ver-aulas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ aluno: nomeAluno })
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const data = await response.json();

      if (data.erro) {
        aulasDadas.textContent = "Erro ao carregar as aulas.";
        aulasRestantes.textContent = "";
        listaAulas.innerHTML = "";
        return;
      }

      aulasDadas.textContent = `‚úÖ J√° teve: ${data.aulas_dadas} aulas`;
      aulasRestantes.textContent = `üìå Faltam: ${data.restantes} aulas`;
      listaAulas.innerHTML = "";
      (data.aulas || []).forEach((aula, i) => {
        const li = document.createElement("li");
        li.textContent = `${i + 1}. üìÖ ${aula.data} üïê ${aula.horario}`;
        listaAulas.appendChild(li);
      });
    } catch (err) {
      console.error("Erro toggleAulas:", err);
      aulasDadas.textContent = "‚ùå Erro ao buscar dados.";
      aulasRestantes.textContent = "";
      listaAulas.innerHTML = "";
    }

    div.style.display = "block";
  };

  window.toggleProfessor = async function () {
    const container = document.getElementById("professor-nome");
    if (container.style.display === "block") {
      container.style.display = "none";
      return;
    }
    container.innerHTML = "Carregando...";
    try {
      const res = await fetch(`/meu-professor-status/${encodeURIComponent(nomeAluno)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const statusIcon = data.online ? 'üü¢' : '‚ö™';
      const statusText = data.online ? 'Online' : 'Offline';
      container.innerHTML = `${statusIcon} Professor: ${data.professor} <span class="status-icon">(${statusText})</span>`;
      container.style.display = "block";
    } catch (e) {
      console.error("Erro toggleProfessor:", e);
      container.innerHTML = "Professor n√£o encontrado.";
      container.style.display = "block";
    }
  };

  window.verNotificacao = async function () {
    try {
      const response = await fetch("/verificar-notificacao", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ aluno: nomeAluno })
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      const notificacaoEl = document.getElementById("notificacao-mensagem");
      const contadorAulas = document.getElementById("contador-aulas");
      if (data.notificacao === true) {
        window.professorEmailAtual = data.professor_email;
        // trocar onclick inline por data-action para robustez poderia ser melhor,
        // mas mantemos compatibilidade com desativarNotificacaoERedirecionar global.
        notificacaoEl.innerHTML = `
          A tua aula ir√° come√ßar
          <button class="notificar-btn" onclick="desativarNotificacaoERedirecionar()">Vista</button>
        `;
        notificacaoEl.style.display = "block";
        contadorAulas.innerText = "(1)";
      } else {
        notificacaoEl.style.display = "none";
        contadorAulas.innerText = "";
      }
    } catch (e) {
      console.error("Erro verNotificacao:", e);
    }
  };

  window.desativarNotificacaoERedirecionar = async function () {
    try {
      await fetch("/desativar-notificacao", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ aluno: nomeAluno })
      });
      document.getElementById("notificacao-mensagem").style.display = "none";
      document.getElementById("contador-aulas").innerText = "";
      if (window.professorEmailAtual) {
        const sala = encodeURIComponent(`${window.professorEmailAtual}-${nomeAluno}`);
        window.location.href = `/sala_virtual_aluno/${sala}`;
      }
    } catch (e) {
      console.error("Erro desativarNotificacaoERedirecionar:", e);
    }
  };

  function toggleDesafio() {
    const desafio = document.getElementById('container-desafio');
    desafio.style.display = (desafio.style.display === 'none' || desafio.style.display === '') 
        ? 'block' 
        : 'none';
}

function fecharDesafio() {
    document.getElementById('container-desafio').style.display = 'none';
}

  window.verHorario = async function () {
    const container = document.getElementById("sec-horario");
    const listaHorario = document.getElementById("lista-horario");

    if (container.style.display === "block") {
      container.style.display = "none";
      return;
    }

    listaHorario.innerHTML = "Carregando...";

    try {
      const res = await fetch(`/ver-horario-aluno/${encodeURIComponent(nomeAluno)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      listaHorario.innerHTML = "";

      if (data.erro) {
        const li = document.createElement("li");
        li.textContent = "‚ö†Ô∏è Hor√°rio n√£o encontrado.";
        listaHorario.appendChild(li);
      } else {
        for (const [dia, horarios] of Object.entries(data.horario || {})) {
          const diaItem = document.createElement("li");
          diaItem.innerHTML = `<strong>üìÖ ${traduzirDia(dia)}:</strong>`;
          listaHorario.appendChild(diaItem);

          (horarios || []).forEach(h => {
            const horaItem = document.createElement("li");
            horaItem.textContent = `- ${h}`;
            horaItem.style.marginLeft = "15px";
            listaHorario.appendChild(horaItem);
          });
        }
      }
    } catch (e) {
      console.error("Erro verHorario:", e);
      listaHorario.innerHTML = "<li>‚ùå Erro ao buscar hor√°rio.</li>";
    }

    container.style.display = "block";
  };

  function traduzirDia(diaAbreviado) {
    const dias = {
      "Seg": "Segunda-feira",
      "Ter": "Ter√ßa-feira",
      "Qua": "Quarta-feira",
      "Qui": "Quinta-feira",
      "Sex": "Sexta-feira",
      "Sab": "S√°bado",
      "Dom": "Domingo"
    };
    return dias[diaAbreviado] || diaAbreviado;
  }

  window.toggle = function (id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
  };

  window.fazerLogout = function () {
    const nomeAlunoForm = document.getElementById("aluno-id")?.value || nomeAluno;
    fetch("/logout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nome: nomeAlunoForm })
    })
    .then(() => window.location.href = "/")
    .catch(error => console.error("Erro ao fazer logout:", error));
  };

  window.entrarNaAulaDireto = function () {
    const salaId = document.getElementById("sala-id").textContent;
    if (salaId) {
      window.location.href = `/sala_virtual_aluno/${salaId}`;
    }
  };

  // ---------------------------
  // JOGO DE INGL√äS (TODAS AS FUN√á√ïES S√ÉO GLOBAIS)
  // ---------------------------

  // estado
  window.perguntas = [];
  window.perguntaAtual = 0;
  window.nivelAtual = ("{{ aluno.nivel_ingles }}" || "iniciante").toLowerCase();

  window.mapaNiveis = {
    basico: "iniciante",
    inicial: "iniciante",
    intermedio: "intermediario",
    medio: "intermediario",
    avancado: "avancado",
    fluente: "fluente"
  };

  // Carrega primeira pergunta / atualiza UI
  window.carregarPerguntas = async function () {
    try {
      const nivelBusca = window.mapaNiveis[window.nivelAtual] || window.nivelAtual;
      const url = `https://beckend-exaap.onrender.com/pergunta-ingles?nome=${encodeURIComponent(nomeAluno)}&nivel=${encodeURIComponent(nivelBusca)}`;
      console.log("carregarPerguntas -> fetch", url);
      const resposta = await fetch(url);
      if (!resposta.ok) throw new Error(`HTTP ${resposta.status}`);
      const dados = await resposta.json();

      // subiu de n√≠vel informado pelo backend
      if (dados.mensagem && dados.novo_nivel) {
        window.nivelAtual = dados.novo_nivel;
        document.getElementById("nivel-aluno").textContent = dados.novo_nivel.toUpperCase();
        const mensagemEl = document.getElementById("mensagem-feedback");
        mensagemEl.textContent = `üöÄ ${dados.mensagem}`;
        setTimeout(() => mensagemEl.textContent = "", 2000);
      }

      if (dados.pergunta) {
        // se backend retorna pergunta diretamente
        window.perguntas = [dados.pergunta];
        // garantir dataset id
        const respostaInput = document.getElementById("resposta-input");
        if (dados.id) {
          respostaInput.dataset.perguntaId = dados.id;
        } else {
          delete respostaInput.dataset.perguntaId;
        }
        document.getElementById("pergunta-texto").textContent = dados.pergunta;
        document.getElementById("nivel-aluno").textContent = (dados.nivel || window.nivelAtual).toUpperCase();
        window.nivelAtual = (dados.nivel || window.nivelAtual).toLowerCase();
      } else if (dados.status === "maximo") {
        document.getElementById("pergunta-texto").textContent = "üèÜ Voc√™ j√° est√° no n√≠vel m√°ximo!";
      } else if (dados.status === "final-nivel") {
        document.getElementById("pergunta-texto").textContent = "üéâ Terminaste todas as perguntas!";
      } else {
        document.getElementById("pergunta-texto").textContent = "Nenhuma pergunta dispon√≠vel.";
      }

    } catch (erro) {
      console.error("Erro carregarPerguntas:", erro);
      document.getElementById("pergunta-texto").textContent = "Erro ao carregar a pergunta.";
    }
  };

  window.mostrarPergunta = async function () {
    try {
      const nivelBusca = window.mapaNiveis[window.nivelAtual] || window.nivelAtual;
      const url = `https://beckend-exaap.onrender.com/pergunta-ingles?nome=${encodeURIComponent(nomeAluno)}&nivel=${encodeURIComponent(nivelBusca)}`;
      console.log("mostrarPergunta -> fetch", url);
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();

      const perguntaTexto = document.getElementById("pergunta-texto");
      const respostaInput = document.getElementById("resposta-input");
      const mensagemFeedback = document.getElementById("mensagem-feedback");

      if (data.pergunta) {
        perguntaTexto.textContent = data.pergunta;
        document.getElementById("nivel-aluno").textContent = (data.nivel || window.nivelAtual).toUpperCase();
        window.nivelAtual = (data.nivel || window.nivelAtual).toLowerCase();

        if (data.id) {
          respostaInput.dataset.perguntaId = data.id;
        } else {
          console.warn("‚ö†Ô∏è Nenhum ID recebido da pergunta!");
          delete respostaInput.dataset.perguntaId;
        }

        respostaInput.value = "";
        mensagemFeedback.textContent = "";

      } else if (data.status === "final-nivel") {
        perguntaTexto.textContent = "üéâ Terminaste todas as perguntas!";
        delete respostaInput.dataset.perguntaId;
      } else {
        perguntaTexto.textContent = "Nenhuma pergunta dispon√≠vel.";
        delete respostaInput.dataset.perguntaId;
      }
    } catch (err) {
      console.error("Erro mostrarPergunta:", err);
      document.getElementById("pergunta-texto").textContent = "Erro ao carregar a pergunta.";
      delete document.getElementById("resposta-input").dataset.perguntaId;
    }
  };

  // A fun√ß√£o chamada pelo bot√£o "Verificar"
  window.verificarResposta = async function () {
    const respostaInput = document.getElementById('resposta-input');
    const btnVerificar = document.getElementById('btn-verificar');
    const resposta = respostaInput.value.trim();
    const perguntaId = respostaInput.dataset.perguntaId;
    const mensagemEl = document.getElementById('mensagem-feedback');

    if (!resposta) {
      mensagemEl.textContent = "‚ö†Ô∏è Escreve uma resposta antes de verificar.";
      return;
    }

    if (!perguntaId) {
      mensagemEl.textContent = "‚ö†Ô∏è Nenhuma pergunta carregada.";
      return;
    }

    // desativa bot√£o enquanto faz requisi√ß√£o
    btnVerificar.disabled = true;
    btnVerificar.style.opacity = "0.6";

    try {
      const response = await fetch("https://beckend-exaap.onrender.com/verificar-resposta", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          nome: nomeAluno,
          resposta: resposta,
          pergunta_id: perguntaId
        }),
      });

      if (!response.ok) {
        // mostrar erro amig√°vel
        throw new Error(`Erro HTTP ${response.status}`);
      }

      const data = await response.json();
      console.log("verificarResposta -> resposta do backend:", data);

      if (data.acertou) {
        if (data.subiu_nivel) {
          mensagemEl.textContent = `üéâ Parab√©ns! Subiste para o n√≠vel ${data.novo_nivel.toUpperCase()}!`;
          // se servidor retornou novo_nivel, atualiza estado
          if (data.novo_nivel) {
            window.nivelAtual = data.novo_nivel.toLowerCase();
            document.getElementById('nivel-aluno').textContent = data.novo_nivel.toUpperCase();
          }
        } else {
          mensagemEl.textContent = "‚úîÔ∏è Resposta correta!";
        }

        respostaInput.value = "";

        setTimeout(async () => {
          mensagemEl.textContent = "";
          // chama a pr√≥xima pergunta de forma segura
          await window.proximaPergunta();
        }, 1200);

      } else {
        mensagemEl.textContent = "‚ùå Resposta incorreta. Tenta novamente!";
      }

    } catch (error) {
      console.error("Erro verificarResposta:", error);
      mensagemEl.textContent = "Erro na verifica√ß√£o. Tenta mais tarde.";
    } finally {
      btnVerificar.disabled = false;
      btnVerificar.style.opacity = "1";
    }
  };

  window.proximaPergunta = async function () {
    try {
      const response = await fetch(`https://beckend-exaap.onrender.com/proxima-pergunta`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome: nomeAluno })
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const dados = await response.json();
      console.log("proximaPergunta -> backend:", dados);

      if (dados.pergunta) {
        document.getElementById("pergunta-texto").textContent = dados.pergunta;
        document.getElementById("nivel-aluno").textContent = (dados.nivel || window.nivelAtual).toUpperCase();
        window.nivelAtual = (dados.nivel || window.nivelAtual).toLowerCase();
        document.getElementById("resposta-input").dataset.perguntaId = dados.id || "";
        document.getElementById("resposta-input").value = "";
      } else if (dados.status === "final-nivel") {
        document.getElementById("pergunta-texto").textContent = "üéâ Terminaste todas as perguntas deste n√≠vel!";
        // chamar subir de n√≠vel
        setTimeout(() => { window.subirNivel(); }, 1000);
      } else {
        document.getElementById("pergunta-texto").textContent = "Nenhuma pergunta dispon√≠vel.";
      }
    } catch (e) {
      console.error("Erro proximaPergunta:", e);
      document.getElementById("pergunta-texto").textContent = "Erro ao carregar pr√≥xima pergunta.";
    }
  };

  window.subirNivel = async function () {
    try {
      const resposta = await fetch('https://beckend-exaap.onrender.com/subir-nivel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome: nomeAluno })
      });
      if (!resposta.ok) throw new Error(`HTTP ${resposta.status}`);
      const dados = await resposta.json();
      console.log("subirNivel -> backend:", dados);

      if (dados.novo_nivel) {
        window.nivelAtual = dados.novo_nivel.toLowerCase();
        document.getElementById('nivel-aluno').textContent = dados.novo_nivel.toUpperCase();
        window.perguntaAtual = 0;

        const mensagemEl = document.getElementById('mensagem-feedback');
        mensagemEl.textContent = `üöÄ Parab√©ns! Agora voc√™ est√° no n√≠vel ${dados.novo_nivel.toUpperCase()}!`;

        setTimeout(async () => {
          mensagemEl.textContent = "";
          // carregar primeira pergunta do novo n√≠vel
          await window.proximaPergunta();
        }, 1500);
      } else if (dados.erro) {
        console.error("Erro ao subir de n√≠vel:", dados.erro);
      }

    } catch (error) {
      console.error("Erro subirNivel:", error);
    }
  };

  // inicia o jogo
  window.carregarPerguntas();

  // exp√µe tamb√©m fun√ß√£o de toggleVisibilidade (mantida global pelo onclick no HTML)
  window.toggleVisibilidade = function () {
    const dividaEl = document.getElementById("valor-divida");
    const inglesEl = document.getElementById("nivel-ingles");

    const visivel = dividaEl.textContent.includes("Kz");

    if (visivel) {
      dividaEl.textContent = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
      inglesEl.textContent = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
    } else {
      const valorReal = dividaEl.dataset.real;
      dividaEl.textContent = `Kz ${valorReal},00`;
      inglesEl.textContent = "{{ aluno.nivel_ingles }}";
    }
  };


  console.log("Fun√ß√µes exportadas para window: toggleAulas, verNotificacao, verHorario, toggleProfessor, verificarResposta, proximaPergunta, subirNivel, carregarPerguntas");
</script>

</body>
</html>
