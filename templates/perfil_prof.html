<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil do Professor</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body {
    margin: 0;
    font-family: 'Nunito', sans-serif;
    background: #f4f4f8;
    color: #333;
    padding-bottom: 70px;
  }

  .header-bai {
    display: flex;
    align-items: center;
    gap: 15px;
    background: linear-gradient(135deg, #00c9ff, #92fe9d);
    padding: 20px;
    border-radius: 0 0 20px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .header-bai img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
  }

  .header-bai .info {
    flex: 1;
  }

  .header-bai .info h2 {
    margin: 0;
    font-size: 20px;
  }

  .header-bai .info p {
    margin: 2px 0;
    font-size: 14px;
  }

  .header-bai .saldo {
    font-size: 16px;
    font-weight: bold;
  }

  .saldo-toggle {
    background-color: #fff;
    color: #000;
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 8px;
    cursor: pointer;
    margin-left: 10px;
  }

  .btn-ver-aulas {
    margin-top: 10px;
    background-color: #ffc107;
    color: #000;
    border: none;
    padding: 10px;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
  }

  .day {
    padding: 6px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    background: #f1f1f1;
  }

  .day.active {
    background-color: #007bff;
    color: white;
    font-weight: bold;
  }

  .time {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: center;
    border-radius: 5px;
    background: #f9f9f9;
    cursor: pointer;
  }

  .time.active {
    background-color: #28a745;
    color: white;
    font-weight: bold;
    border-color: #218838;
  }
/* Mensagens */
.msg-professor, .msg-aluno {
  max-width: 70%;
  margin-bottom: 12px;
  padding: 10px 15px;
  border-radius: 15px;
  font-size: 0.9rem;
  line-height: 1.4;
  word-wrap: break-word;
}

.msg-professor {
  background: #00c9ff;
  color: white;
  margin-right: auto;
  border-bottom-left-radius: 0;
}

.msg-aluno {
  background: #92fe9d;
  color: #2c3e50;
  margin-left: auto;
  border-bottom-right-radius: 0;
}

/* Hover no bot√£o enviar */
.input-chat button:hover {
  transform: scale(1.1);
}

/* Bot√£o de fechar modal */
.fechar-btn {
  position: absolute;
  top: 8px;
  right: 12px;
  background: none;
  border: none;
  color: #333;
  font-size: 1.5rem;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s ease;
  z-index: 1001;
}

.fechar-btn:hover {
  transform: scale(1.2);
  color: #e74c3c;
}

/* Garante que o modal tenha posi√ß√£o relativa */
.modal-info {
  position: relative;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

  .botao-padrao {
    background: linear-gradient(135deg, #00c9ff, #92fe9d);
    border: none;
    border-radius: 16px;
    padding: 10px 12px;
    font-size: 14px;
    font-weight: 600;
    color: #000;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: 0.2s ease;
    text-align: center;
    margin-top: 10px;
    margin-right: 5px;
  }

  .botao-padrao:hover {
    opacity: 0.85;
  }
  
  .logout-button {
    position: fixed; 
    top: 15px;
    right: 20px;
    background-color: #ff4d4f;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    font-weight: bold;
    cursor: pointer;
    font-size: 13px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 1000; 
  }

  .logout-button:hover {
    background-color: #d9363e;
  }

  .botao-menu {
    display: flex;
    justify-content: space-between;
    flex-wrap: nowrap;
    gap: 10px;
    margin: 20px 15px;
  }

  .botao-menu button {
    flex: 1;
    background: linear-gradient(135deg, #00c9ff, #92fe9d);
    border: none;
    border-radius: 16px;
    padding: 15px 10px;
    font-size: 14px;
    font-weight: 600;
    color: #000;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: 0.2s ease;
    text-align: center;
  }

  .botao-menu button:hover {
    opacity: 0.85;
  }

  .ultimas-aulas {
    padding: 20px;
  }

  .ultimas-aulas h3 {
    margin-bottom: 15px;
  }

  .aula-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    cursor: pointer;
  }

  .aula-item i {
    color: #007bff;
    margin-right: 10px;
  }

  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    z-index: 100;
  }

  .bottom-nav button {
    background: none;
    border: none;
    font-size: 20px;
    color: #444;
    cursor: pointer;
  }

  .secao-dinamica {
    display: none;
    padding: 20px;
    margin: 10px 15px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.05);
  }

  .secao-dinamica h4 {
    margin-bottom: 10px;
    color: #00796b;
  }

  @media (max-width: 700px) {
    .botao-menu {
      flex-wrap: nowrap;
      overflow-x: auto;
    }

    .botao-menu button {
      min-width: 120px;
      flex: 0 0 auto;
    }
  }

  /* Overlay fundo escuro */
  .overlay-info {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    animation: fadeIn 0.3s ease;
  }

  /* Modal container */
  .modal-info {
    background: #fff;
    padding: 25px 30px;
    border-radius: 18px;
    max-width: 420px;
    width: 90%;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    animation: slideUp 0.4s ease;
    font-family: 'Nunito', sans-serif;
    position: relative;
  }

  .modal-info h3 {
    margin-bottom: 15px;
    font-size: 1.4rem;
    font-weight: 700;
    color: #2c3e50;
    text-align: center;
  }

  /* Linha de informa√ß√£o */
  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 10px 0;
    font-size: 1rem;
    color: #444;
    border-bottom: 1px solid #eee;
    padding-bottom: 6px;
  }

  .info-row span:first-child {
    font-weight: bold;
    color: #2c3e50;
  }

  /* Bot√µes (reaproveitando .botao-padrao j√° existente) */
  .botao-padrao {
    background: linear-gradient(135deg, #00c9ff, #92fe9d);
    border: none;
    border-radius: 20px;
    color: #fff;
    font-weight: 600;
    padding: 8px 15px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: 0.3s;
  }

  .botao-padrao:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }

  /* Fechar (√≠cone no canto) */
  .fechar-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: transparent;
    color: #555;
    font-size: 1.2rem;
    cursor: pointer;
    border: none;
  }

  .fechar-btn:hover {
    color: #e74c3c;
    transform: scale(1.2);
  }

  /* Anima√ß√µes */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from { transform: translateY(40px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
</style>
  
</head>
 <!-- Bot√£o de logout no canto superior direito -->
  <form method="POST" action="/logout_prof" style="position: fixed; top: 10px; right: 15px; z-index: 1000;">
    <input type="hidden" name="email" value="{{ professor.email }}">
    <button type="submit" class="logout-button">Sair</button>
  </form>  

  <div class="header-bai">
    <img src="/static/perfil.png" alt="Foto Perfil">
    <div class="info">
      <h2>Ol√°, {{ professor.nome_completo }} üëã</h2>
      <p>N¬∫ B.I: {{ professor.bilhete }}</p>
      <p class="saldo">
        Saldo: 
        <span id="saldo">Kz ******</span>
        <span class="saldo-toggle" onclick="toggleSaldo()">üëÅÔ∏è</span>
      </p>
    </div>
  </div>

<!-- Bot√µes principais -->
<div class="botao-menu">
  <button onclick="toggleSection('meus-alunos', listarMeusAlunos)">Meus alunos</button>
  <button onclick="toggleSection('alunos-disponiveis', buscarAlunosDisponiveis)">Novos alunos dispon√≠veis</button>
  <button onclick="toggleSection('aulas-dia', mostrarAulasDoDia)">Aulas do dia</button>
  <button onclick="toggleSection('aulas-semana', mostrarAulasDaSemana)">Aulas da Semana</button>
</div>

<!-- üìö √öltimas Aulas Dadas -->
<div class="ultimas-aulas" style="margin-top: 20px; background: #ffffff; padding: 16px 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
  <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 20px; color: #333;">√öltimas aulas dadas</h3>
  <ul id="lista-ultimas-aulas" style="list-style: none; padding: 0; margin: 0;">
    <li style="padding: 12px 0; border-bottom: 1px solid #eee; font-size: 17px; color: #444;">
      Carregando...
    </li>
  </ul>
</div>

<!-- Se√ß√µes din√¢micas -->
<div id="alunos-disponiveis" class="secao-dinamica">
  <h4>Alunos Dispon√≠veis</h4>
  <div id="lista-alunos-disponiveis"></div>
</div>

<div id="meus-alunos" class="secao-dinamica">
  <h4>Meus Alunos</h4>
  <div id="lista-meus-alunos"></div>
</div>

<div id="ver-dados" class="secao-dinamica">
  <h4>Meus Dados</h4>
  <p>Email: {{ professor.email }}</p>
  <p>Telefone: {{ professor.telefone }}</p>
</div>

<!-- Aulas do Dia -->
<div id="aulas-dia" class="secao-dinamica" style="display:none; margin-top:10px; background:#f9f9f9; padding:10px; border-radius:8px;">
  <h4>Aulas de Hoje</h4>
  <div id="lista-aulas-dia"></div>
</div>

<!-- Aulas da Semana -->
<div id="aulas-semana" class="secao-dinamica" style="display:none; margin-top:10px; background:#eef; padding:10px; border-radius:8px;">
  <h4>Minhas Aulas da Semana</h4>
  <div id="lista-aulas-semana"></div>
</div>

<!-- FUNDO ESCURO PARA DETECTAR CLIQUE FORA -->
<div id="calendarOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.2); z-index:999;" onclick="fecharCalendarioSeForFora(event)">
  <!-- CAIXA CALEND√ÅRIO -->
  <div id="calendarContainer" onclick="event.stopPropagation()" style="position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; border:1px solid #ccc; padding:15px; z-index:1000; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.2); width:350px; max-height:85vh; overflow-y:auto; font-size:14px;">
    <h4>Selecionar Hor√°rios</h4>
    <div id="daySelector" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;"></div>
    <div id="timeSelector" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;"></div>
    <div style="margin-top:15px; text-align:right;">
      <button onclick="enviarHorario()" style="background:#28a745; color:#fff; border:none; padding:8px 12px; border-radius:5px;">Enviar o hor√°rio</button>
      <button onclick="fecharCalendario()" style="margin-left:10px;">Fechar</button>
    </div>
  </div>
</div>

<!-- Painel de Informa√ß√µes -->
<div id="painel-informacoes" style="display:none; position:fixed; bottom:60px; left:10px; right:10px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); z-index:1000; font-size:15px; max-height:80vh; overflow-y:auto;">
  <h3 style="margin-top:0; color:#333;">Bem-vindo(a) √† Sabi L√≠der!</h3>
  <p>O seu centro de forma√ß√£o online, onde pode lecionar de forma flex√≠vel, segura e eficiente ‚Äî sem sair de casa.</p>

  <h4 style="margin-top:15px; color:#444;">üåü Vantagens das aulas online</h4>
  <ul style="padding-left:20px; line-height:1.6;">
    <li>Flexibilidade de hor√°rios: ensine quando quiser.</li>
    <li>Sem deslocamentos: economize tempo e custos.</li>
    <li>Conex√£o direta com os alunos: intera√ß√µes em tempo real.</li>
    <li>Ambiente organizado: hist√≥rico, chamadas e relat√≥rios num s√≥ lugar.</li>
    <li>Privacidade e seguran√ßa de dados garantidos.</li>
  </ul>

  <h4 style="margin-top:15px; color:#444;">üîê Pol√≠ticas de Privacidade</h4>
  <ul style="padding-left:20px; line-height:1.6;">
    <li>Todos os dados s√£o protegidos e armazenados com seguran√ßa.</li>
    <li>O uso da plataforma est√° sujeito √† autoriza√ß√£o de acesso individual.</li>
    <li>O professor compromete-se a manter a √©tica e o respeito nas aulas.</li>
    <li>O conte√∫do gerado √© de responsabilidade do educador.</li>
  </ul>

  <h4 style="margin-top:15px; color:#444;">üßæ Modo de Uso</h4>
  <ul style="padding-left:20px; line-height:1.6;">
    <li>Use o menu inferior para navegar entre alunos, sal√°rios e aulas.</li>
    <li>Consulte sua agenda semanal com um clique.</li>
    <li>Ao iniciar uma aula, garanta boa conex√£o e ambiente tranquilo.</li>
    <li>Comunique-se com clareza e esteja sempre dispon√≠vel nos hor√°rios acordados.</li>
  </ul>

  <div style="text-align:right; margin-top:20px;">
    <button onclick="fecharMenuResumo()" style="background:#dc3545; color:#fff; border:none; padding:8px 12px; border-radius:5px;">Fechar</button>
  </div>
</div>

<!-- Navega√ß√£o inferior -->
<div class="bottom-nav">
  <button onclick="abrirPerfil()" title="Meu Perfil">
    <i class="fas fa-user-circle"></i>
  </button>
  <button onclick="abrirSalarios()" title="Sal√°rios">
    <i class="fas fa-money-bill-wave"></i>
  </button>
  <button onclick="abrirMenuResumo()" title="Informa√ß√µes">
    <i class="fas fa-bars"></i>
  </button>
</div>

<!-- Formul√°rio oculto para redirecionar ao perfil -->
<form method="POST" action="/dados_professor" id="form-dados-prof" style="display:none;">
  <input type="hidden" name="email" id="prof-email-hidden">
</form>

<div id="chat-modal-aluno" style="display: none; position: fixed; top: 0; left: 0; 
     width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
  
  <div id="chat-container" style="background: white; width: 400px; max-width: 90%; height: 500px; display: flex; flex-direction: column; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
    
    <!-- Barra superior com bot√£o fechar -->
    <div class="top-bar" style="background: linear-gradient(135deg, #00c9ff, #92fe9d); padding: 15px; display: flex; align-items: center; justify-content: space-between;">
      <div class="info" style="display: flex; flex-direction: column;">
        <h2 id="professor-nome" style="font-size: 1rem; margin: 0; color: #ffffff; font-weight: 600;">Carregando...</h2>
        <p id="professor-disciplina" style="margin: 2px 0; color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">---</p>
      </div>
      <!-- Bot√£o de fechar -->
      <button class="fechar-btn" onclick="fecharChatAluno()" style="background:none; border:none; color:white; font-size:1.5rem; font-weight:bold; cursor:pointer;">‚úñ</button>
    </div>

    <!-- √Årea de mensagens -->
    <div id="mensagens-chat" class="mensagens-chat" style="flex: 1; overflow-y: auto; padding: 15px; background: #f9fbfd;"></div>

    <!-- Input de mensagem -->
    <div class="input-chat" style="display: flex; border-top: 1px solid #e0e0e0; background: white; padding: 10px;">
      <input type="text" id="input-msg" placeholder="Escreva uma mensagem..." style="flex: 1; border: none; outline: none; padding: 12px; border-radius: 25px; background: #f0f2f5; margin-right: 10px; font-size: 0.9rem;">
      <button id="enviar-msg" style="border: none; background: linear-gradient(135deg, #00c9ff, #92fe9d); color: white; border-radius: 50%; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease;">‚û§</button>
    </div>

  </div>
</div>

  
<script>


let saldoVisivel = false;
let saldoReal = 0;

async function buscarSaldo() {
  try {
    const email = "{{ professor.email }}";
    const res = await fetch(`/saldo-atual?email=${encodeURIComponent(email)}`);
    const data = await res.json();
    if (data.saldo_atual !== undefined) {
      saldoReal = data.saldo_atual;
    }
  } catch (error) {
    console.error("Erro ao buscar saldo:", error);
  }
}

async function toggleSaldo() {
  const saldo = document.getElementById('saldo');

  // Buscar o saldo apenas se ainda for 0
  if (!saldoReal) {
    await buscarSaldo();
  }

  if (saldoVisivel) {
    saldo.textContent = 'Kz ******';
  } else {
    saldo.textContent = 'Kz ' + saldoReal.toLocaleString('pt-PT', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  saldoVisivel = !saldoVisivel;
}
  
  function verDetalhesAula(aluno, hora) {
    alert("Aula para: " + aluno + "\nHor√°rio: " + hora + "\nDura√ß√£o: 1h\nValor: Kz 1.250,00");
  }

  function abrirMenuResumo() {
    const painel = document.getElementById("painel-informacoes");
    painel.style.display = "block";
  }

  function fecharMenuResumo() {
    const painel = document.getElementById("painel-informacoes");
    painel.style.display = "none";
  }

  function toggleDados() {
    const div = document.getElementById('dadosSecretos');
    div.style.display = div.style.display === 'block' ? 'none' : 'block';
  }

  function toggleSection(id, fetchFunction) {
    const section = document.getElementById(id);
    if (section.style.display === 'block') {
      section.style.display = 'none';
    } else {
      section.style.display = 'block';
      if (typeof fetchFunction === 'function') {
        fetchFunction();
      }
    }
  }
  
function abrirSalarios() {
    const email = "{{ professor.email }}";
    window.location.href = `/salarios?email=${encodeURIComponent(email)}`;
  }
  
  function abrirPerfil() {
    const email = "{{ professor.email }}";
    document.getElementById('prof-email-hidden').value = email;
    document.getElementById('form-dados-prof').submit();
  }

  async function enviarNotificacao(aluno) {
    try {
      const resposta = await fetch("/ativar-notificacao", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          aluno: aluno
        })
      });

      const resultado = await resposta.json();
      alert(resultado.msg || "Notifica√ß√£o enviada!");
    } catch (error) {
      console.error("Erro ao enviar notifica√ß√£o:", error);
      alert("Erro ao enviar notifica√ß√£o.");
    }
  }

async function mostrarAulasDoDia() {
  const professorEmail = "{{ professor.email }}";

  const resposta = await fetch("/aulas_do_dia", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ professor_email: professorEmail })
  });

  const dados = await resposta.json();
  const lista = document.getElementById("lista-aulas-dia");
  lista.innerHTML = "";

  if (dados.aulas && Array.isArray(dados.aulas) && dados.aulas.length > 0) {
    dados.aulas.forEach(item => {
      const bloco = document.createElement("div");
      bloco.style.marginBottom = "10px";
      bloco.innerHTML = `
        <div style="padding: 6px 10px; background: #fff; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <strong>${item.aluno}</strong><br>
          Hor√°rios: ${item.horarios.join(", ")}<br>
          Valor: ${item.preco}
        </div>
      `;
      lista.appendChild(bloco);
    });
  } else {
    lista.innerHTML = "Nenhuma aula marcada para hoje.";
  }
}

async function mostrarAulasDaSemana() {
  const professorEmail = "{{ professor.email }}";

  const resposta = await fetch("/aulas_da_semana", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ professor_email: professorEmail })
  });

  const dados = await resposta.json();
  const lista = document.getElementById("lista-aulas-semana");
  lista.innerHTML = "";

  if (dados.aulas && typeof dados.aulas === "object" && Object.keys(dados.aulas).length > 0) {
    // ‚úÖ Ordem corrigida conforme backend com OrderedDict
    const diasOrdenados = [
      "Domingo", "Segunda-feira", "Ter√ßa-feira",
      "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"
    ];

    diasOrdenados.forEach(dia => {
      const aulasDia = dados.aulas[dia];
      if (aulasDia && aulasDia.length > 0) {
        const diaDiv = document.createElement("div");
        diaDiv.style.marginBottom = "15px";
        diaDiv.innerHTML = `<h5 style="text-transform: capitalize;">${dia}</h5>`;

        aulasDia.forEach(item => {
          const aulaItem = document.createElement("div");
          aulaItem.style.marginLeft = "10px";
          aulaItem.innerHTML = `
            <strong>${item.aluno}</strong>: ${item.horarios.join(", ")}<br>
            Valor: ${item.preco}
          `;
          diaDiv.appendChild(aulaItem);
        });

        lista.appendChild(diaDiv);
      }
    });
  } else {
    lista.innerHTML = "Nenhuma aula marcada para esta semana.";
  }
}
  
  function slugify(text) {
    return text
      .toLowerCase()
      .replace(/\s+/g, '-')       
      .replace(/[^\w\-@.]+/g, '') 
      .replace(/\-\-+/g, '-')     
      .replace(/^-+/, '')         
      .replace(/-+$/, '');        
  }

  async function iniciarChamada(aluno, professorEmail) {
    try {
      await enviarNotificacao(aluno);

      // Registrar a aula no Firebase
      await fetch("/iniciar-aula", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          aluno: aluno,
          professor: professorEmail,
          sala: `${slugify(professorEmail)}-${slugify(aluno)}`
        })
      });

      // ‚úÖ Definir status como "ok"
      await fetch("/definir-status-ok", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ aluno: aluno })
      });

      // Redirecionar para a sala
    window.location.href = `/sala_virtual_professor?email=${encodeURIComponent(professorEmail)}&aluno=${encodeURIComponent(aluno)}`;
    } catch (error) {
      console.error("Erro ao iniciar chamada:", error);
      alert("Erro ao iniciar a chamada.");
    }
  }
  
let alunoSelecionado = null;
let modalChatAberta = false;
let professorSelecionado = null;
let chatInterval = null;

async function listarMeusAlunos() {
  const emailProfessorLogado = "{{ professor.email }}";

  try {
    const res = await fetch(`/meus-alunos-status/${encodeURIComponent(emailProfessorLogado)}`);
    const lista = await res.json();
    const container = document.getElementById('meus-alunos');
    container.innerHTML = '<h2>Meus Alunos</h2>';

    if (lista.length === 0) {
      container.innerHTML += '<p>Nenhum aluno vinculado ainda.</p>';
      return;
    }

    lista.forEach(aluno => {
      const card = document.createElement('div');
      card.className = 'aluno-card';

      const statusClass = aluno.online ? 'online' : 'offline';
      const statusText = aluno.online ? 'Online' : 'Offline';

      card.innerHTML = `
        <div class="aluno-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span><strong>${aluno.nome}</strong> - ${aluno.disciplina}</span>
          <div class="status">
            <span>${statusText}</span>
            <span class="status-dot ${statusClass}"></span>
          </div>
        </div>
      `;

      // Fun√ß√£o auxiliar para criar bot√µes
      const criarBotao = (texto, onClick) => {
        const btn = document.createElement('button');
        btn.textContent = texto;
        btn.className = 'botao-padrao';
        btn.onclick = (e) => { e.stopPropagation(); onClick(); };
        return btn;
      };

      // Bot√£o Dar Aula
      if (aluno.online) {
        card.appendChild(criarBotao('Dar Aula', () => iniciarChamada(aluno.nome, emailProfessorLogado)));
      }

      // Bot√£o Informa√ß√µes
      card.appendChild(criarBotao('Informa√ß√µes', () => exibirInformacoesAluno(aluno)));

      // Bot√£o Chat (funcional)
      const chatBtn = document.createElement('button');
      chatBtn.innerHTML = '<i class="fa-solid fa-comment"></i> Chat';
      chatBtn.className = 'botao-padrao';
      chatBtn.onclick = (e) => {
        e.stopPropagation();
        abrirChatProfessorDoAluno(aluno.nome.toLowerCase());
      };
      card.appendChild(chatBtn);

      // Bot√£o Desvincular
      card.appendChild(criarBotao('Desvincular', () => desvincularAluno(aluno.nome, emailProfessorLogado)));

      // Bot√£o Hor√°rio
      card.appendChild(criarBotao('Hor√°rio', () => { alunoSelecionado = aluno.nome; abrirCalendario(); }));

      // Bot√£o Aulas Dadas
      card.appendChild(criarBotao('Aulas dadas', () => verAulasDadas(aluno.nome)));

      container.appendChild(card);
    });

  } catch (error) {
    console.error("Erro ao buscar alunos:", error);
    alert("Erro ao buscar alunos.");
  }
}

// Abrir chat do professor com o aluno (nome do aluno no topo)
async function abrirChatProfessorDoAluno(nomeAluno) {
  const modal = document.getElementById("chat-modal-aluno");
  modal.style.display = "flex";
  modalChatAberta = true;
  alunoSelecionado = nomeAluno;

  try {
    const res = await fetch(`/professor-do-aluno/${encodeURIComponent(nomeAluno)}`);
    if (!res.ok) throw new Error("N√£o foi poss√≠vel buscar professor do aluno");

    const data = await res.json();
    if (!data.professor || !data.email) return;

    professorSelecionado = data.email;

    // Mostrar o nome do ALUNO no topo do chat
    document.getElementById("professor-nome").innerText = nomeAluno;
    document.getElementById("professor-disciplina").innerText = data.disciplina || "---";

    // Carregar mensagens iniciais
    carregarMensagens(data.mensagens || []);

    // Evita m√∫ltiplos intervalos
    if (chatInterval) clearInterval(chatInterval);
    chatInterval = setInterval(() => {
      if (modalChatAberta) carregarMensagens();
    }, 2000);

    // Enviar mensagem
    document.getElementById("enviar-msg").onclick = async () => {
      const input = document.getElementById("input-msg");
      const mensagem = input.value.trim();
      if (!mensagem) return;

      try {
        await fetch("/enviar-mensagem", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            aluno: nomeAluno,
            professor: professorSelecionado,
            mensagem,
            remetente: "professor"
          })
        });
        input.value = "";
        carregarMensagens();
      } catch (err) {
        console.error("Erro ao enviar mensagem:", err);
      }
    };

  } catch (err) {
    console.error("Erro ao abrir chat do aluno:", err);
  }
}

// Fechar chat
function fecharChatAluno() {
  document.getElementById("chat-modal-aluno").style.display = "none";
  modalChatAberta = false;
  if (chatInterval) clearInterval(chatInterval);
}


async function carregarMensagens(mensagensIniciais = null) {
  if (!alunoSelecionado || !professorSelecionado) return;

  try {
    let msgs = mensagensIniciais;
    if (!msgs) {
      const res = await fetch(`/buscar-mensagens/${professorSelecionado}/${alunoSelecionado}`);
      msgs = await res.json();
    }

    const container = document.getElementById('mensagens-chat');
    container.innerHTML = "";

    const hoje = new Date().toDateString(); 

    msgs.forEach(m => {
      const div = document.createElement('div');
      div.className = m.remetente === 'professor' ? 'msg-professor' : 'msg-aluno';

      // Criar elemento de mensagem com texto
      const msgText = document.createElement('span');
      msgText.textContent = m.mensagem;
      div.appendChild(msgText);

      // Formatar timestamp
      if (m.timestamp) {
        const dataMsg = new Date(m.timestamp); 
        let horarioTexto = "";

        if (dataMsg.toDateString() === hoje) {
          // S√≥ hora e minuto
          const h = String(dataMsg.getHours()).padStart(2, '0');
          const min = String(dataMsg.getMinutes()).padStart(2, '0');
          horarioTexto = `${h}:${min}`;
        } else {
          // Data completa
          const d = String(dataMsg.getDate()).padStart(2, '0');
          const mth = String(dataMsg.getMonth() + 1).padStart(2, '0');
          const y = dataMsg.getFullYear();
          const h = String(dataMsg.getHours()).padStart(2, '0');
          const min = String(dataMsg.getMinutes()).padStart(2, '0');
          horarioTexto = `${d}/${mth}/${y} ${h}:${min}`;
        }

        const horaSpan = document.createElement('span');
        horaSpan.style.display = 'block';
        horaSpan.style.fontSize = '0.7rem';
        horaSpan.style.color = 'rgba(0,0,0,0.5)';
        horaSpan.style.marginTop = '2px';
        horaSpan.textContent = horarioTexto;
        div.appendChild(horaSpan);
      }

      container.appendChild(div);
    });

    container.scrollTop = container.scrollHeight;

  } catch (err) {
    console.error("Erro ao carregar mensagens:", err);
  }
}

let modalAberta = false;

function exibirInformacoesAluno(aluno) {
  // Se j√° estiver aberta, fecha
  if (modalAberta) {
    document.querySelector('.overlay-info')?.remove();
    modalAberta = false;
    return;
  }

  const overlay = document.createElement('div');
  overlay.className = 'overlay-info';

  const modal = document.createElement('div');
  modal.className = 'modal-info';

  modal.innerHTML = `
    <button class="fechar-btn"><i class="fa-solid fa-xmark"></i></button>
    <h3><i class="fa-solid fa-user-graduate"></i> ${aluno.nome}</h3>

    <div class="info-row">
      <span><i class="fa-solid fa-phone"></i> Telefone:</span>
      <span>
        <a href="https://wa.me/${aluno.telefone}" target="_blank">${aluno.telefone || '-'}</a>
        <button class="botao-padrao" onclick="navigator.clipboard.writeText('${aluno.telefone}')">
          <i class="fa-solid fa-copy"></i>
        </button>
      </span>
    </div>

    <div class="info-row"><span><i class="fa-solid fa-map"></i> Prov√≠ncia:</span> <span>${aluno.provincia || '-'}</span></div>
    <div class="info-row"><span><i class="fa-solid fa-city"></i> Munic√≠pio:</span> <span>${aluno.municipio || '-'}</span></div>
    <div class="info-row"><span><i class="fa-solid fa-house"></i> Bairro:</span> <span>${aluno.bairro || '-'}</span></div>
    <div class="info-row"><span><i class="fa-solid fa-language"></i> Ingl√™s:</span> <span>${aluno.nivel_ingles || '-'}</span></div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  modalAberta = true;

  // Bot√£o fechar
  modal.querySelector('.fechar-btn').onclick = () => {
    overlay.remove();
    modalAberta = false;
  };

  // Clique fora da modal fecha
  overlay.onclick = (e) => {
    if (e.target === overlay) {
      overlay.remove();
      modalAberta = false;
    }
  };
}
  
async function verAulasDadas(nomeAluno) {
  try {
    const response = await fetch("/ver-aulas", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ aluno: nomeAluno })
    });

    const data = await response.json();

    if (data.erro) {
      alert("Erro: " + data.erro);
      return;
    }

    let mensagem = `Aulas dadas para ${nomeAluno}:\n\n`;
    mensagem += `Total de aulas dadas: ${data.aulas_dadas}\n`;
    mensagem += `Aulas restantes: ${data.restantes}`;

    alert(mensagem);
  } catch (error) {
    console.error("Erro ao buscar aulas dadas:", error);
    alert("Erro ao buscar aulas dadas.");
  }
}

// Fun√ß√£o para desvincular aluno
async function desvincularAluno(nomeAluno, professorEmail) {
  if (!confirm(`Tens certeza que desejas desvincular o aluno ${nomeAluno}?`)) return;

  try {
    const res = await fetch("/desvincular-aluno", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        aluno: nomeAluno,
        professor: professorEmail
      })
    });

    const data = await res.json();

    if (res.ok) {
      alert("Aluno desvinculado com sucesso.");
      listarMeusAlunos(); // üîÑ Atualiza a lista
    } else {
      alert("Erro: " + data.detail);
    }
  } catch (err) {
    console.error("Erro ao desvincular:", err);
    alert("Erro ao tentar desvincular o aluno.");
  }
}
  
async function carregarUltimasAulas(professorEmail) {
    try {
      const resposta = await fetch("/ultimas-aulas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ professor_email: professorEmail })
      });

      const resultado = await resposta.json();

      const lista = document.getElementById("lista-ultimas-aulas");
      lista.innerHTML = ""; // limpar antes de preencher

      if (resultado.ultimas_aulas && resultado.ultimas_aulas.length > 0) {
        resultado.ultimas_aulas.forEach((aula) => {
          const item = document.createElement("li");
          item.innerHTML = `<strong>${aula.nome}</strong> - ${aula.data} √†s ${aula.horario}`;
          lista.appendChild(item);
        });
      } else {
        lista.innerHTML = "<li>Nenhuma aula registrada ainda.</li>";
      }

    } catch (error) {
      console.error("Erro ao carregar √∫ltimas aulas:", error);
    }
  }

  const professorEmail = "{{ professor.email }}";
  carregarUltimasAulas(professorEmail);
  
 async function buscarAlunosDisponiveis() {
  const email = "{{ professor.email }}";
  try {
    const res = await fetch(`/alunos-disponiveis/${encodeURIComponent(email)}`);
    const lista = await res.json();
    const container = document.getElementById('alunos-disponiveis');
    container.innerHTML = '<h2>Alunos Dispon√≠veis</h2>';

    if (lista.length === 0) {
      container.innerHTML += '<p>Nenhum aluno dispon√≠vel no momento.</p>';
      return;
    }

    lista.forEach(aluno => {
      const card = document.createElement('div');
      card.className = 'aluno-card';

      const nomeAluno = aluno.nome;
      const disciplina = aluno.disciplina;

      card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${nomeAluno}</strong> - ${disciplina}
          </div>
        </div>
      `;

      // Bot√£o Informa√ß√µes
      const infoBtn = document.createElement('button');
      infoBtn.textContent = 'Informa√ß√µes';
      infoBtn.className = 'botao-padrao';
      infoBtn.onclick = (e) => {
        e.stopPropagation();
        exibirInformacoesAluno(aluno); 
      };
      card.appendChild(infoBtn);

      // Bot√£o Vincular
      const vincularBtn = document.createElement('button');
      vincularBtn.textContent = 'Vincular';
      vincularBtn.className = 'botao-padrao';
      vincularBtn.onclick = (e) => {
        e.stopPropagation();
        vincularAluno(nomeAluno, '{{ professor.email }}');
      };
      card.appendChild(vincularBtn);

      container.appendChild(card);
    });
  } catch (error) {
    console.error("Erro ao buscar alunos dispon√≠veis:", error);
    alert("Erro ao buscar alunos dispon√≠veis.");
  }
}

// Fun√ß√£o modal j√° usada para ambos os casos
function exibirInformacoesAluno(aluno) {
  const overlay = document.createElement('div');
  overlay.className = 'overlay-info';

  const modal = document.createElement('div');
  modal.className = 'modal-info';

  modal.innerHTML = `
    <h3>${aluno.nome}</h3>
    <div class="info-row">
      <span>Telefone:</span>
      <span>
        <a href="https://wa.me/${aluno.telefone}" target="_blank">${aluno.telefone || '-'}</a>
        <button class="botao-padrao" onclick="navigator.clipboard.writeText('${aluno.telefone}')">Copiar</button>
      </span>
    </div>
    <div class="info-row"><span>Prov√≠ncia:</span> <span>${aluno.provincia || '-'}</span></div>
    <div class="info-row"><span>Munic√≠pio:</span> <span>${aluno.municipio || '-'}</span></div>
    <div class="info-row"><span>Bairro:</span> <span>${aluno.bairro || '-'}</span></div>
    <div class="info-row"><span>N√≠vel de Ingl√™s:</span> <span>${aluno.nivel_ingles || '-'}</span></div>
    <button class="botao-padrao fechar-btn">Fechar</button>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  modal.querySelector('.fechar-btn').onclick = () => overlay.remove();
  overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };
}

  async function vincularAluno(nomeAluno, professorEmail) {
    try {
      const res = await fetch('/vincular-aluno', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          professor_email: professorEmail,
          aluno_nome: nomeAluno
        })
      });

      if (res.ok) {
        alert(`Aluno "${nomeAluno}" vinculado com sucesso!`);
        buscarAlunosDisponiveis();
      } else {
        const erro = await res.json();
        alert(`Erro: ${erro.detail}`);
      }
    } catch (error) {
      console.error('Erro ao vincular aluno:', error);
      alert('Erro interno ao tentar vincular o aluno.');
    }
  }
  
let horarioSelecionado = {}; 
let diaAtivo = ""; 

function abrirCalendario() {
  const overlay = document.getElementById('calendarOverlay');
  overlay.style.display = 'block';
  gerarCalendario();
}

function fecharCalendario() {
  document.getElementById('calendarOverlay').style.display = 'none';
}

function fecharCalendarioSeForFora(event) {
  if (event.target.id === 'calendarOverlay') {
    fecharCalendario();
  }
}

function gerarCalendario() {
  const dias = ['Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado', 'Domingo'];
  const daySelector = document.getElementById('daySelector');
  const timeSelector = document.getElementById('timeSelector');

  daySelector.innerHTML = '';
  timeSelector.innerHTML = '';
  diaAtivo = ""; 

  dias.forEach(dia => {
    const div = document.createElement('div');
    div.textContent = dia;
    div.className = 'day';
    div.onclick = () => {
      document.querySelectorAll('.day').forEach(d => d.classList.remove('active'));
      div.classList.add('active');
      diaAtivo = dia;
      gerarHorarios(); 
    };
    daySelector.appendChild(div);
  });
}

function gerarHorarios() {
  const timeSelector = document.getElementById('timeSelector');
  timeSelector.innerHTML = '';

  if (!diaAtivo) return;

  const horariosSalvos = horarioSelecionado[diaAtivo] || [];

  const inicio = 7.5;
  const fim = 20.5;

  for (let h = inicio; h < fim; h++) {
    const horaInicial = `${Math.floor(h)}:${h % 1 ? '30' : '00'}`;
    const horaFinal = `${Math.floor(h + 1)}:${(h + 1) % 1 ? '30' : '00'}`;
    const texto = `${horaInicial} - ${horaFinal}`;
    const div = document.createElement('div');
    div.textContent = texto;
    div.className = 'time';

    if (horariosSalvos.includes(texto)) {
      div.classList.add('active');
    }

    div.onclick = () => {
      div.classList.toggle('active');
      if (!horarioSelecionado[diaAtivo]) {
        horarioSelecionado[diaAtivo] = [];
      }
      if (div.classList.contains('active')) {
        horarioSelecionado[diaAtivo].push(texto);
      } else {
        horarioSelecionado[diaAtivo] = horarioSelecionado[diaAtivo].filter(h => h !== texto);
      }
    };
    timeSelector.appendChild(div);
  }
}

async function enviarHorario() {
  if (!alunoSelecionado || Object.keys(horarioSelecionado).length === 0) {
    alert("Selecione pelo menos um dia e hor√°rio.");
    return;
  }

  const professorEmail = "{{ professor.email }}";

  const mapaDias = {
    "Segunda-feira": "Seg",
    "Ter√ßa-feira": "Ter",
    "Quarta-feira": "Qua",
    "Quinta-feira": "Qui",
    "Sexta-feira": "Sex",
    "S√°bado": "S√°b",
    "Domingo": "Dom"
  };

  const horarioFormatado = {};
  for (const dia in horarioSelecionado) {
    const abreviado = mapaDias[dia] || dia;
    horarioFormatado[abreviado] = horarioSelecionado[dia];
  }

  const payload = {
    aluno_nome: alunoSelecionado,
    professor_email: professorEmail,
    horario: horarioFormatado
  };

  try {
  
    const response = await fetch("/enviar-horario", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (response.ok) {
      alert(`Hor√°rio enviado com sucesso para ${alunoSelecionado}!`);

      
      const diasSelecionados = Object.keys(horarioSelecionado);
      const ultimoDia = diasSelecionados[diasSelecionados.length - 1];
      const horarios = horarioSelecionado[ultimoDia];

      if (ultimoDia && horarios && horarios.length > 0) {
        const guardarPayload = {
          aluno: alunoSelecionado,
          dias: [ultimoDia],
          horarios: horarios
        };

        const guardarResponse = await fetch("/guardar-horario", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(guardarPayload)
        });

        const guardarData = await guardarResponse.json();
        if (guardarResponse.ok) {
          console.log("Hor√°rio tamb√©m guardado com sucesso!");
        } else {
          console.warn("Erro ao guardar hor√°rio:", guardarData.erro || "Erro desconhecido.");
        }
      }

      fecharCalendario();
    } else {
      alert("Erro ao enviar hor√°rio: " + (data.detail || "Erro desconhecido."));
    }
  } catch (e) {
    alert("Erro ao enviar o hor√°rio.");
    console.error(e);
  }
}

  function toggleDados() {
    const div = document.getElementById("dadosSecretos");
    div.style.display = div.style.display === "none" ? "block" : "none";

    const mensagensDiv = document.getElementById("mensagensAdmin");
    mensagensDiv.style.display = mensagensDiv.style.display === "none" ? "block" : "none";
  }

  async function buscarMensagensProfessor() {
    const email = "{{ professor.email }}".trim().toLowerCase();
    const res = await fetch(`/mensagens-professor/${email}`);
    const dados = await res.json();

    const lista = document.getElementById("listaMensagens");
    lista.innerHTML = "";

    if (dados.mensagens && dados.mensagens.length > 0) {
      dados.mensagens.forEach(msg => {
        const item = document.createElement("li");
        item.style.padding = "10px";
        item.style.borderBottom = "1px solid #ffe082";
        item.innerHTML = `<strong>${msg.data || "Sem data"}:</strong><br>${msg.texto}`;
        lista.appendChild(item);
      });
    } else {
      lista.innerHTML = "<li style='color:#777'>Nenhuma mensagem recebida ainda.</li>";
    }
  }

 
  window.addEventListener("DOMContentLoaded", buscarMensagensProfessor);
</script>
</body>
</html>
