<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Conex√£o com o Professor</title>
<style>
  body {
    margin: 0;
    background: #000;
    font-family: "Roboto", sans-serif;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100vh;
    overflow: hidden;
  }

  .video-container {
    position: relative;
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  #remoteVideo {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: black;
  }

  .blur-top,
  .blur-bottom {
    position: absolute;
    left: 0;
    width: 100%;
    height: 5%;
    backdrop-filter: blur(15px) brightness(0.8);
    -webkit-backdrop-filter: blur(15px) brightness(0.8);
    pointer-events: none;
    z-index: 2;
  }

  .blur-top { top: 0; }
  .blur-bottom { bottom: 0; }

  #localVideo {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 120px;
    height: 90px;
    border: 2px solid #fff;
    z-index: 3;
    border-radius: 6px;
    object-fit: cover;
    background: black;
  }

  #status {
    position: absolute;
    top: 10px;
    width: 100%;
    text-align: center;
    font-size: 16px;
    z-index: 4;
  }

  #notificacao {
    display: none;
    position: absolute;
    bottom: 120px;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    z-index: 5;
  }

  #notificacao button {
    margin: 5px;
    padding: 8px 16px;
    background: #28a745;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
  }

  #notificacao button#nao {
    background: #dc3545;
  }

  #pagamento {
    display: none;
    position: absolute;
    bottom: 50px;
    background: rgba(0, 0, 0, 0.9);
    padding: 15px;
    border-radius: 8px;
    z-index: 6;
    text-align: center;
  }

  #pagamento button {
    padding: 10px 20px;
    background: #007bff;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 5px;
  }
</style>
</head>
<body>
  <div class="video-container">
    <video id="remoteVideo" autoplay playsinline preload="auto" disablePictureInPicture></video>
    <div class="blur-top"></div>
    <div class="blur-bottom"></div>
  </div>

  <video id="localVideo" autoplay muted playsinline preload="auto" disablePictureInPicture></video>
  <div id="status">üîé Buscando chamada do professor...</div>

  <div id="notificacao">
    <p>Est√° gostando da aula?</p>
    <button id="sim">Sim</button>
    <button id="nao">N√£o</button>
  </div>

  <div id="pagamento">
    <p>Precisa fazer o pagamento para continuar com as aulas.</p>
    <button id="fazerPagamento">Fazer pagamento</button>
  </div>

  <button id="reconectarBtn" style="display:none; position:fixed; bottom:20px; right:20px; padding:10px 20px; background:linear-gradient(135deg,#00c9ff,#92fe9d); border:none; border-radius:8px; color:#fff; font-weight:600; cursor:pointer; box-shadow:0 0 12px rgba(0,0,0,0.2);">
    üîÅ Chamar Professor
  </button>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

<script>
  const statusEl = document.getElementById("status");
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const notificacao = document.getElementById("notificacao");
  const pagamento = document.getElementById("pagamento");
  const btnSim = document.getElementById("sim");
  const btnNao = document.getElementById("nao");
  const btnPagamento = document.getElementById("fazerPagamento");
  const reconectarBtn = document.getElementById("reconectarBtn");

  const aluno = "{{ aluno }}";
  const professor = "{{ professor }}";

  let peer;
  let localStream;
  let currentCall;
  let etapa = 1;
  let intervaloVisual;
  let somTocado = false;

  // === INTERVALO VISUAL ===
  const intervaloContainer = document.createElement("div");
  intervaloContainer.style.cssText = `
    display:none; position:fixed; top:0; left:0;
    width:100vw; height:100vh; background:rgba(0,0,0,0.8);
    z-index:9999; justify-content:center; align-items:center;
    flex-direction:column; color:#fff; font-family:'Nunito',sans-serif;
  `;
  const circulo = document.createElement("div");
  circulo.style.cssText = `
    width:180px;height:180px;border-radius:50%;
    background:conic-gradient(#00c9ff,#92fe9d,#00c9ff);
    animation:girar 4s linear infinite; box-shadow:0 0 30px rgba(0,201,255,0.6);
    display:flex;justify-content:center;align-items:center;
  `;
  const tempoIntervalo = document.createElement("div");
  tempoIntervalo.style.cssText = `
    font-size:2.5em;font-weight:bold;color:#fff;position:absolute;
  `;
  const avisoInicio = document.createElement("div");
  avisoInicio.style.cssText = `
    margin-top:30px;font-size:1.3em;font-weight:600;
    color:#ffeb3b;text-align:center;
  `;
  intervaloContainer.appendChild(circulo);
  intervaloContainer.appendChild(tempoIntervalo);
  intervaloContainer.appendChild(avisoInicio);
  document.body.appendChild(intervaloContainer);

  const style = document.createElement("style");
  style.innerHTML = `
    @keyframes girar { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
  `;
  document.head.appendChild(style);

  const somAviso = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");

  // === C√ÇMERA E OTIMIZA√á√ÉO ===
  async function startCamera() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: { ideal: 1280 },
          height: { ideal: 720 },
          frameRate: { ideal: 30, max: 60 }
        },
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
      });
      localVideo.srcObject = localStream;

      // Otimiza bitrate (estabilidade e qualidade)
      localStream.getTracks().forEach(track => {
        const sender = currentCall?.peerConnection?.getSenders()?.find(s => s.track === track);
        if (sender && sender.setParameters) {
          const params = sender.getParameters();
          if (!params.encodings) params.encodings = [{}];
          params.encodings[0].maxBitrate = 2500000; // 2.5 Mbps para v√≠deo HD
          sender.setParameters(params);
        }
      });

      return true;
    } catch (err) {
      console.error("Erro ao acessar c√¢mera/microfone:", err);
      statusEl.textContent = "‚ö†Ô∏è Falha ao iniciar c√¢mera/microfone";
      return false;
    }
  }

  // === INICIAR PEER ===
  function initPeerAndConnect(peerIdDoProfessor) {
    peer = new Peer({
      config: {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
          { urls: "turn:relay1.expressturn.com:3478", username: "efy", credential: "turnsecret" }
        ]
      },
      debug: 2
    });

    peer.on("open", () => {
      statusEl.textContent = "üîó Conectando ao professor...";
      currentCall = peer.call(peerIdDoProfessor, localStream, {
        metadata: { aluno: aluno, qualidade: "HD" }
      });
      handleCallEvents(currentCall);
    });

    peer.on("error", err => {
      console.error("PeerJS Error:", err);
      statusEl.textContent = "Erro de conex√£o com o servidor.";
    });
  }

  // === EVENTOS DE CHAMADA ===
  function handleCallEvents(call) {
    currentCall = call;
    call.on("stream", async (remoteStream) => {
      remoteVideo.srcObject = remoteStream;
      await remoteVideo.play().catch(() => console.warn("‚ö†Ô∏è Clique para liberar som"));
      statusEl.textContent = `üé• Conectado com qualidade HD (Etapa ${etapa}/3)`;
      iniciarCronometroAula();
    });
    call.on("close", () => statusEl.textContent = "üîå Conex√£o encerrada.");
    call.on("error", err => console.error("Erro na chamada:", err));
  }

  // === FLUXO DE CONEX√ÉO ===
  async function verificarPermissaoEConectar() {
    try {
      const resp = await fetch(`/registrar-chamada`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ aluno, professor })
      });
      const result = await resp.json();
      if (resp.ok && result.sala) buscarPeerIdEDiscar();
      else statusEl.textContent = "‚ùå Conex√£o n√£o autorizada.";
    } catch {
      statusEl.textContent = "‚ö†Ô∏è Erro ao verificar autoriza√ß√£o.";
    }
  }

  async function buscarPeerIdEDiscar() {
    const alunoNormalizado = aluno.trim().toLowerCase().replace(/\s/g, "");
    let tentativas = 0;
    const maxTentativas = 30;
    statusEl.textContent = "‚åõ Aguardando o professor iniciar a chamada...";
    while (tentativas < maxTentativas) {
      const res = await fetch(`/buscar-id-professor?aluno=${alunoNormalizado}`);
      const data = await res.json();
      if (data.peer_id) {
        initPeerAndConnect(data.peer_id);
        return;
      }
      await new Promise(r => setTimeout(r, 2000));
      tentativas++;
    }
    statusEl.textContent = "üö´ Professor ausente.";
  }

  // === CRON√îMETRO ===
  function iniciarCronometroAula() {
    let tempoRestante = 1260;
    const cronometro = setInterval(() => {
      if (tempoRestante <= 0) {
        clearInterval(cronometro);
        encerrarEtapa();
      } else tempoRestante--;
    }, 1000);
  }

  // === ENCERRAMENTO DE ETAPA ===
  function encerrarEtapa() {
    try { currentCall?.close(); } catch {}
    remoteVideo.srcObject = null;
    if (etapa < 3) {
      etapa++;
      statusEl.textContent = `‚è±Ô∏è Etapa encerrada. Intervalo de 5 minutos...`;
      mostrarIntervaloVisual();
    } else {
      statusEl.textContent = "‚úÖ Aula finalizada ap√≥s 3 blocos de 21 minutos.";
    }
  }

  // === INTERVALO COM RECONEX√ÉO MANUAL ===
  function mostrarIntervaloVisual() {
    let tempo = 300;
    somTocado = false;
    intervaloContainer.style.display = "flex";
    avisoInicio.textContent = "";
    atualizarIntervalo();

    intervaloVisual = setInterval(() => {
      tempo--;
      atualizarIntervalo();
      if (tempo === 60 && !somTocado) {
        avisoInicio.textContent = "‚ö†Ô∏è Faltam 60 segundos para o in√≠cio da pr√≥xima etapa!";
        somAviso.play().catch(() => console.log("Som bloqueado."));
        somTocado = true;
      }
      if (tempo <= 0) {
        clearInterval(intervaloVisual);
        intervaloContainer.style.display = "none";
        statusEl.textContent = "üïì Intervalo conclu√≠do. Clique para chamar o professor.";
        reconectarBtn.style.display = "inline-block";
      }
    }, 1000);

    function atualizarIntervalo() {
      const m = Math.floor(tempo / 60).toString().padStart(2, "0");
      const s = (tempo % 60).toString().padStart(2, "0");
      tempoIntervalo.textContent = `${m}:${s}`;
    }
  }

  // === BOT√ÉO MANUAL DE RECONEX√ÉO ===
  reconectarBtn.onclick = async () => {
    reconectarBtn.style.display = "none";
    statusEl.textContent = "üîÑ Reconectando...";
    await buscarPeerIdEDiscar();
  };

  // === PAGAMENTO ===
  btnSim.onclick = () => { notificacao.style.display = "none"; pagamento.style.display = "block"; };
  btnNao.onclick = () => (notificacao.style.display = "none");
  btnPagamento.onclick = () => {
    window.location.href = `/enviar_comprovativo?aluno_nome=${encodeURIComponent(aluno)}`;
  };

  // === IN√çCIO ===
  startCamera().then(ok => { if (ok) verificarPermissaoEConectar(); });
</script>
</body>
</html>
