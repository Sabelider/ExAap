<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Conex√£o com o Professor</title>
<style>
  body {
    margin: 0;
    background: #000;
    font-family: "Roboto", sans-serif;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100vh;
    overflow: hidden;
  }

  .video-container {
    position: relative;
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  #remoteVideo {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: black;
  }

  .blur-top,
  .blur-bottom {
    position: absolute;
    left: 0;
    width: 100%;
    height: 5%;
    backdrop-filter: blur(15px) brightness(0.8);
    -webkit-backdrop-filter: blur(15px) brightness(0.8);
    pointer-events: none;
    z-index: 2;
  }

  .blur-top { top: 0; }
  .blur-bottom { bottom: 0; }

  #localVideo {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 140px;
    height: 100px;
    border: 2px solid #fff;
    z-index: 3;
    border-radius: 8px;
    object-fit: cover;
    background: black;
  }

  #status {
    position: absolute;
    top: 10px;
    width: 100%;
    text-align: center;
    font-size: 16px;
    z-index: 4;
  }

  #notificacao {
    display: none;
    position: absolute;
    bottom: 120px;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    z-index: 5;
  }

  #notificacao button {
    margin: 5px;
    padding: 8px 16px;
    background: #28a745;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
  }

  #notificacao button#nao { background: #dc3545; }

  #pagamento {
    display: none;
    position: absolute;
    bottom: 50px;
    background: rgba(0, 0, 0, 0.9);
    padding: 15px;
    border-radius: 8px;
    z-index: 6;
    text-align: center;
  }

  #pagamento button {
    padding: 10px 20px;
    background: #007bff;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 5px;
  }

  #reconectarBtn {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 20px;
    background: linear-gradient(135deg,#00c9ff,#92fe9d);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 0 12px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>
  <div class="video-container">
    <video id="remoteVideo" autoplay playsinline preload="auto" disablePictureInPicture></video>
    <div class="blur-top"></div>
    <div class="blur-bottom"></div>
  </div>

  <video id="localVideo" autoplay muted playsinline preload="auto" disablePictureInPicture></video>
  <div id="status">üîé Buscando chamada do professor...</div>

  <div id="notificacao">
    <p>Est√° gostando da aula?</p>
    <button id="sim">Sim</button>
    <button id="nao">N√£o</button>
  </div>

  <div id="pagamento">
    <p>Precisa fazer o pagamento para continuar com as aulas.</p>
    <button id="fazerPagamento">Fazer pagamento</button>
  </div>

  <button id="reconectarBtn">üîÅ Chamar Professor</button>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
  const statusEl = document.getElementById("status");
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const notificacao = document.getElementById("notificacao");
  const pagamento = document.getElementById("pagamento");
  const btnSim = document.getElementById("sim");
  const btnNao = document.getElementById("nao");
  const btnPagamento = document.getElementById("fazerPagamento");
  const reconectarBtn = document.getElementById("reconectarBtn");

  const aluno = "{{ aluno }}";
  const professor = "{{ professor }}";

  let peer, localStream, currentCall;
  let etapa = 1;

  // === C√ÇMERA ===
  async function startCamera() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: { ideal: 1920 },
          height: { ideal: 1080 },
          frameRate: { ideal: 60, max: 60 }
        },
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
      });
      localVideo.srcObject = localStream;
      return true;
    } catch (err) {
      console.error("Erro ao acessar c√¢mera/microfone:", err);
      statusEl.textContent = "‚ö†Ô∏è Falha ao iniciar c√¢mera/mic.";
      return false;
    }
  }

  // === REFOR√áO AUTOM√ÅTICO DE TRANSMISS√ÉO ===
  function iniciarReforcoTransmissao() {
    setInterval(async () => {
      if (!currentCall || !currentCall.peerConnection) return;
      try {
        statusEl.textContent = "üîÅ Refor√ßo de transmiss√£o ativo...";
        const pc = currentCall.peerConnection;

        // Reaplica par√¢metros de qualidade
        pc.getSenders().forEach(sender => {
          if (sender.track && sender.track.kind === "video") {
            const params = sender.getParameters();
            params.degradationPreference = "maintain-framerate";
            params.encodings = [{
              maxBitrate: 3500000, // 3.5 Mbps
              minBitrate: 800000,
              scaleResolutionDownBy: 1.0
            }];
            sender.setParameters(params);
          }
        });

        // Verifica se o v√≠deo local travou
        if (localVideo.srcObject && localVideo.srcObject.getVideoTracks()[0].readyState === "ended") {
          const newStream = await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 60 } },
            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
          });
          const sender = pc.getSenders().find(s => s.track.kind === "video");
          if (sender) sender.replaceTrack(newStream.getVideoTracks()[0]);
          localStream = newStream;
          localVideo.srcObject = newStream;
        }

        // Restaura √°udio se estiver inativo
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack && !audioTrack.enabled) audioTrack.enabled = true;

        setTimeout(() => {
          statusEl.textContent = "üì° Transmiss√£o estabilizada.";
        }, 2000);
      } catch (e) {
        console.warn("Erro no refor√ßo:", e);
      }
    }, 60000); // A cada 1 minuto
  }

  // === INICIAR PEER ===
  function initPeerAndConnect(peerIdDoProfessor) {
    peer = new Peer({
      config: {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
          { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
          { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
        ]
      },
      debug: 2
    });

    peer.on("open", () => {
      statusEl.textContent = "üîó Conectando ao professor...";
      const call = peer.call(peerIdDoProfessor, localStream, { metadata: { aluno } });
      handleCallEvents(call);
    });

    peer.on("error", err => {
      console.error("PeerJS error:", err);
      statusEl.textContent = "Erro de rede, tentando reconectar...";
      setTimeout(() => buscarPeerIdEDiscar(), 3000);
    });
  }

  // === EVENTOS DE CHAMADA ===
  function handleCallEvents(call) {
    currentCall = call;
    call.on("stream", stream => {
      remoteVideo.srcObject = stream;
      remoteVideo.play().catch(() => console.log("Som bloqueado."));
      statusEl.textContent = "üì° Conectado com o professor - transmiss√£o HD";
      iniciarReforcoTransmissao();
    });

    call.on("close", () => statusEl.textContent = "üîå Conex√£o encerrada.");
    call.on("error", err => console.warn("Erro de chamada:", err));
  }

  // === VERIFICA√á√ÉO E CONEX√ÉO ===
  async function verificarPermissaoEConectar() {
    try {
      const resp = await fetch(`/registrar-chamada`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ aluno, professor })
      });
      const result = await resp.json();
      if (resp.ok && result.sala) buscarPeerIdEDiscar();
      else statusEl.textContent = "‚ùå Conex√£o n√£o autorizada.";
    } catch {
      statusEl.textContent = "‚ö†Ô∏è Erro ao verificar autoriza√ß√£o.";
    }
  }

  async function buscarPeerIdEDiscar() {
    const alunoNorm = aluno.trim().toLowerCase().replace(/\s/g, "");
    let tentativas = 0;
    const maxTentativas = 30;
    statusEl.textContent = "‚åõ Aguardando o professor iniciar...";
    while (tentativas < maxTentativas) {
      const res = await fetch(`/buscar-id-professor?aluno=${alunoNorm}`);
      const data = await res.json();
      if (data.peer_id) {
        initPeerAndConnect(data.peer_id);
        return;
      }
      await new Promise(r => setTimeout(r, 2000));
      tentativas++;
    }
    statusEl.textContent = "üö´ Professor ausente.";
  }

  btnSim.onclick = () => { notificacao.style.display = "none"; pagamento.style.display = "block"; };
  btnNao.onclick = () => notificacao.style.display = "none";
  btnPagamento.onclick = () => {
    window.location.href = `/enviar_comprovativo?aluno_nome=${encodeURIComponent(aluno)}`;
  };

  startCamera().then(ok => { if (ok) verificarPermissaoEConectar(); });
</script>
</body>
</html>

