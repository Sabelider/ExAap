<!DOCTYPE html> 
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sala Virtual - Professor</title>
<style>
  body {
    margin: 0;
    background: #000;
    font-family: "Roboto", sans-serif;
    color: #fff;
    overflow: hidden;
  }

  /* Container principal */
  .video-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    grid-auto-rows: 200px;
    gap: 10px;
    width: 100%;
    height: 100vh;
    padding: 10px;
    box-sizing: border-box;
  }

  /* Vídeos remotos dos alunos */
  .remoteVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border: 2px solid #444;
    border-radius: 10px;
    background: #111;
  }

  /* Vídeo local do professor (miniatura) */
  #localVideo {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 160px;
    height: 120px;
    border: 2px solid #fff;
    border-radius: 10px;
    z-index: 20;
  }

  /* Cronômetro */
  #cronometro {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    padding: 8px 18px;
    border-radius: 20px;
    font-size: 22px;
    font-weight: bold;
    display: none;
    z-index: 30;
  }

  /* Botão confirmar aula */
  #confirmarAulaBtn {
    display: none;
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #ffa500;
    color: black;
    font-weight: bold;
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    z-index: 30;
  }

  /* Botão chamar aluno */
  #chamarAlunoBtn {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: green;
    color: white;
    font-weight: bold;
    padding: 12px 22px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    z-index: 30;
  }
</style>
</head>
<body>
  <div id="cronometro">01:00</div>

  <!-- Todos os vídeos remotos dos alunos aparecem aqui -->
  <div class="video-container" id="videoGrid"></div>

  <!-- Vídeo local do professor -->
  <video id="localVideo" autoplay muted playsinline></video>

  <button id="chamarAlunoBtn" onclick="enviarIdAoPerfil()">Chamar Alunos</button>
  <button id="confirmarAulaBtn" onclick="registrarAula()">Confirmar aula dada?</button>

  <!-- Firebase + PeerJS -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

  <script>
    const localVideo = document.getElementById("localVideo");
    const videoGrid = document.getElementById("videoGrid");
    const cronometro = document.getElementById("cronometro");
    const confirmarAulaBtn = document.getElementById("confirmarAulaBtn");
    const chamarAlunoBtn = document.getElementById("chamarAlunoBtn");

    const email = "{{ email }}";
    const aluno = "{{ aluno }}"; // pode ser null → vários alunos

    let localStream;
    let peer;
    let meuPeerId = "";
    let conexoes = {};
    let tempoRestante = 3600; // 1 hora
    let intervalo;

    async function startCamera() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
      } catch (err) {
        alert("Erro ao acessar câmera/microfone");
        console.error(err);
      }
    }

    function initPeer() {
      peer = new Peer();

      peer.on("open", (id) => {
        meuPeerId = id;
      });

      peer.on("call", (call) => {
        call.answer(localStream);
        handleCallEvents(call);
      });

      peer.on("error", (err) => {
        console.error("Erro PeerJS:", err);
      });
    }

    function handleCallEvents(call) {
      call.on("stream", (remoteStream) => {
        addRemoteVideo(call.peer, remoteStream);
        iniciarCronometro();
      });

      call.on("close", () => {
        removeRemoteVideo(call.peer);
      });

      conexoes[call.peer] = call;
    }

    function addRemoteVideo(peerId, stream) {
      if (document.getElementById(peerId)) return;

      const video = document.createElement("video");
      video.id = peerId;
      video.srcObject = stream;
      video.autoplay = true;
      video.playsInline = true;
      video.classList.add("remoteVideo");

      videoGrid.appendChild(video);
    }

    function removeRemoteVideo(peerId) {
      const video = document.getElementById(peerId);
      if (video) {
        video.remove();
      }
    }

    function enviarIdAoPerfil() {
      chamarAlunoBtn.style.display = "none";

      fetch("/enviar-id-aula", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          peer_id: meuPeerId,
          email: email.trim().toLowerCase()
        })
      })
      .then(res => {
        if (res.ok) alert("✅ ID da aula enviado!");
        else alert("⚠️ Erro ao enviar ID.");
      })
      .catch(err => {
        console.error("Erro:", err);
      });
    }

    function iniciarCronometro() {
      if (cronometro.style.display === "block") return; // já está rodando
      cronometro.style.display = "block";
      tempoRestante = 3600;

      intervalo = setInterval(() => {
        if (tempoRestante <= 0) {
          clearInterval(intervalo);
          cronometro.textContent = "00:00";
          return;
        }

        tempoRestante--;
        let minutos = Math.floor(tempoRestante / 60).toString().padStart(2, '0');
        let segundos = (tempoRestante % 60).toString().padStart(2, '0');
        cronometro.textContent = `${minutos}:${segundos}`;
      }, 1000);
    }

    function registrarAula() {
      confirmarAulaBtn.disabled = true;
      confirmarAulaBtn.style.display = "none";

      fetch("/registrar-aula", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          professor: email.trim().toLowerCase()
        })
      })
      .then(res => {
        if (res.ok) {
          alert("✅ Aula registrada!");
        } else {
          alert("⚠️ Falha ao registrar aula.");
          confirmarAulaBtn.style.display = "inline-block";
          confirmarAulaBtn.disabled = false;
        }
      })
      .catch(err => {
        console.error("Erro ao registrar aula:", err);
        confirmarAulaBtn.style.display = "inline-block";
        confirmarAulaBtn.disabled = false;
      });
    }

    startCamera().then(initPeer);
  </script>
</body>
</html>
